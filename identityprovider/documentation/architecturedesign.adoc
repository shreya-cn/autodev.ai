= Identity Provider Service Architecture Design

This document provides a comprehensive architecture overview of the Identity Provider Service. It includes diagrams and descriptions of the system architecture, component interactions, infrastructure, and external system integrations.

== 1. Service Architecture Overview

=== High-level System Architecture Diagram

[plantuml, "system_architecture_diagram", png]
----
@startuml

package "Identity Provider Application" {
    [IdentityproviderApplication] as (Startup)
    [UserController] as (Controller)
    [UserService] as (UserService)
    [JWTService] as (JWTService)
    [SecurityConfig] as (SecurityConfig)
    [JwtAuthFilter] as (JwtAuthFilter)
    [UserRepository] as (UserRepository)
    [AuditService] as (AuditService)
    [EmailService] as (EmailService)
    [TokenBlacklistService] as (TokenBlacklistService)
    [NotificationService] as (NotificationService)
}

database "Identity DB" {
    [User]
    [Role]
    [Token]
    [Client]
}

(Startup) .down.> (Controller) : initiates
(Controller) .right.> (UserService) : uses
(UserService) .down.> (UserRepository) : interacts
(UserService) .right.> (JWTService) : uses
(JWTService) .down.> (AuditService) : logs
(JWTService) .down.> (TokenBlacklistService) : manages tokens
(UserService) .left.> (EmailService) : sends emails
(EmailService) .left.> (NotificationService) : notifies
(SecurityConfig) .up.> (JwtAuthFilter) : configures

UserRepository - [User]
UserRepository - [Role]
UserRepository - [Token]
UserRepository - [Client]

@enduml
----

=== External System Connections and Integrations

The Identity Provider Service integrates with the following external systems:

- **Email Systems**: For sending registration and notification emails.
- **Notification Services**: For sending real-time user notifications.
- **External Authentication Providers**: For OAuth and third-party logins (not shown in the diagram).

=== Component Interaction Overview

The system is initiated from the `IdentityproviderApplication`, which sets up the Spring Boot application. The `UserController` handles all incoming HTTP requests related to user management such as login, registration, and token refresh. `UserService` manages all user-related operations including interactions with the `UserRepository` for database access. `JWTService` is used for creating and validating JWT tokens, and it interacts with `AuditService` for logging and `TokenBlacklistService` for managing blacklisted tokens. `EmailService` uses `NotificationService` to send out emails and notifications.

=== Technology Stack and Frameworks Used

- **Spring Boot**: Framework for building Java-based applications.
- **Spring Security**: For authentication and authorization.
- **JWT**: JSON Web Tokens for secure transmission of information.
- **Hibernate**: ORM tool for database interaction.
- **MySQL**: Database for storing user and authentication data.
- **Maven**: Build tool.
- **JUnit**: For unit testing.

== 2. Component Description

=== IdentityproviderApplication

**Responsibility**: Bootstraps the Spring Boot application.

**Role**: Entry point of the application.

**Interactions**: Initializes the Spring context and starts the application server.

**Dependencies**: Spring Boot.

=== UserController

**Responsibility**: Handles all user-related HTTP requests.

**Role**: Controller in the MVC pattern.

**Interactions**: Interacts with `UserService` for business operations and sends responses back to the client.

**Dependencies**: `UserService`, `JWTService`.

=== UserService

**Responsibility**: Manages all business logic related to users.

**Role**: Service layer component.

**Interactions**: Uses `UserRepository` to persist and retrieve user data. Utilizes `JWTService` for token operations and `EmailService` for sending emails.

**Dependencies**: `UserRepository`, `JWTService`, `EmailService`.

=== JWTService

**Responsibility**: Manages JWT token creation, validation, and invalidation.

**Role**: Service layer component.

**Interactions**: Logs operations via `AuditService` and manages blacklisted tokens with `TokenBlacklistService`.

**Dependencies**: None explicitly, uses Java security libraries.

=== SecurityConfig

**Responsibility**: Configures security settings for the application.

**Role**: Configuration class.

**Interactions**: Sets up authentication and authorization mechanisms and configures `JwtAuthFilter`.

**Dependencies**: Spring Security.

== 3. Infrastructure Architecture

=== Deployment Architecture

The Identity Provider Service is containerized using Docker, allowing it to be deployed on any environment that supports Docker, such as Kubernetes clusters or standalone Docker hosts.

=== Database Architecture

The service uses MySQL as its relational database. It stores users, roles, tokens, and client information. Hibernate is used as the ORM tool to manage database operations.

=== Security Architecture

The system uses Spring Security for authentication and authorization. Passwords are stored in hashed formats using BCrypt. JWT tokens are used for maintaining user sessions.

=== Network Architecture

The service is designed to be deployed within a secure VPC with controlled access. Only specific ports are exposed, and communication between services is secured using TLS.

== 4. System Context

=== External Systems and Their Interfaces

- **Email System**: SMTP protocol.
- **Notification Service**: REST API.

=== Data Flow Between Systems

1. User data flows from `UserController` to `UserService` and then to `UserRepository` for persistence.
2. Authentication data flows from `UserController` to `JWTService` for token generation and validation.
3. Notification data flows from `EmailService` to external email and notification systems.

=== Authentication and Authorization Flows at System Level

1. User sends login credentials.
2. `UserController` captures and forwards credentials to `UserService`.
3. `UserService` authenticates credentials and requests `JWTService` to generate a token.
4. `JWTService` returns the token which is sent back to the user.

This document provides a detailed overview of the Identity Provider Service architecture, suitable for architects and senior developers to understand and extend the system.
= Identity Provider Service Architecture Design

This document provides a comprehensive overview of the architecture for the Identity Provider service, detailing the system's components, interactions, and infrastructure.

== 1. Service Architecture Overview

=== High-level System Architecture Diagram

The following PlantUML diagram represents the high-level architecture of the Identity Provider service:

```plantuml
@startuml
package "Identity Provider Service" {
    [IdentityproviderApplication] as App
    [UserController] as Controller
    [UserService] as UserService
    [JWTService] as JWTService
    [SecurityConfig] as SecurityConfig
    [JwtAuthFilter] as JwtAuthFilter
    [UserRepository] as UserRepository
    [AuditService] as AuditService
    [EmailService] as EmailService
    [NotificationService] as NotificationService
    [TokenBlacklistService] as TokenBlacklistService
}

database "Identity DB" {
    [User]
    [Role]
    [Token]
    [Client]
}

App --> Controller
Controller --> UserService
UserService --> UserRepository
UserService --> AuditService
UserService --> EmailService
UserService --> JWTService
JWTService --> AuditService
JWTService --> TokenBlacklistService
EmailService --> NotificationService
SecurityConfig --> JwtAuthFilter
JwtAuthFilter --> UserService
UserRepository --> [Identity DB]
@enduml
```

=== External System Connections and Integrations

The Identity Provider service integrates with the following external systems:

- **Email System**: For sending registration and notification emails.
- **Notification System**: For sending real-time user notifications.

=== Component Interaction Overview

The `UserController` handles HTTP requests and interacts with `UserService` for user-related operations. `UserService` accesses `UserRepository` for database operations and utilizes `JWTService` for token management and `EmailService` for sending emails. `JWTService` also interacts with `AuditService` for logging and `TokenBlacklistService` for token invalidation.

=== Technology Stack and Frameworks Used

- **Spring Boot**: Framework for creating stand-alone, production-grade Spring-based applications.
- **Spring Security**: For authentication and access-control.
- **JWT**: For secure transmission of information between parties as a JSON object.
- **Hibernate**: For ORM-based database operations.
- **MySQL**: As the relational database.
- **Maven**: For project management and build automation.

== 2. Component Description

=== IdentityproviderApplication

The entry point of the application, responsible for bootstrapping and launching the Spring Boot application.

=== JwtAuthFilter

A filter that intercepts requests to validate JWT tokens for secured endpoints.

=== SecurityConfig

Configures web security, defining beans for authentication and authorization processes.

=== UserController

Handles all user-related endpoints such as login, registration, and token refresh. It interacts with `UserService` for business operations.

=== UserService

Provides business logic for user management, interacts with `UserRepository` for data persistence, and uses `JWTService` for token operations.

=== JWTService

Manages JWT token operations such as creation, extraction, validation, and invalidation.

=== UserRepository

Spring Data repository that abstracts CRUD operations for the `User` entity.

=== AuditService

Responsible for logging security-related events within the application.

=== EmailService

Manages sending emails to users, utilizes `NotificationService` for notifying the system about the operation status.

=== NotificationService

Handles sending notifications to users.

=== TokenBlacklistService

Provides services to blacklist tokens, preventing them from being reused.

== 3. Infrastructure Architecture

=== Deployment Architecture

The application is containerized using Docker, allowing it to be deployed on any Docker-compatible host, including cloud platforms like AWS, Azure, or GCP.

=== Database Architecture

Uses MySQL as the database with tables for `Users`, `Roles`, `Tokens`, and `Clients`. Hibernate ORM is used for database interaction.

=== Security Architecture

Utilizes Spring Security for authentication and authorization, integrating JWT for stateless session management. Passwords are stored in hashed form using BCrypt.

=== Network Architecture

The service is deployed within a private subnet with controlled access via load balancers. Only HTTPS traffic is permitted, ensuring encrypted data transmission.

== 4. System Context

=== External Systems and Their Interfaces

- **Email System**: SMTP protocol used for sending emails.
- **Notification System**: RESTful API for sending notifications.

=== Data Flow Between Systems

User data flows from the `UserController` to the `UserService` and then to either the `UserRepository` or external systems like Email and Notification services depending on the operation.

=== Authentication and Authorization Flows at System Level

Authentication is managed via JWT tokens issued at login. Each request is filtered through `JwtAuthFilter` to validate the token before processing the request. Authorization is role-based, managed by Spring Security configurations.

This architecture document provides a clear, high-level overview of the Identity Provider service, suitable for use by architects and senior developers to understand and potentially enhance the system.
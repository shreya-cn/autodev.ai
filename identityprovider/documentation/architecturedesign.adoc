= Identity Provider System Architecture Design

This document provides a comprehensive architecture design for the Identity Provider system, detailing the service architecture, component interactions, infrastructure setup, and system context. The system is designed using Java Spring Boot, focusing on security and efficient data handling.

== Service Architecture Overview

=== High-level System Architecture Diagram

[plantuml, diagram-architecture, png]
----
@startuml
package "Identity Provider Application" {
  [IdentityproviderApplication] as app
  [SecurityConfig] as security
  [UserController] as controller
  [UserService] as userService
  [JWTService] as jwtService
  [AuditService] as auditService
  [EmailService] as emailService
  [TokenBlacklistService] as tokenBlacklist
  [NotificationService] as notificationService
  [UserRepository] as userRepository
}

database "Database" {
  [User]
  [Role]
  [Token]
  [Client]
}

app --> security
controller --> userService
controller --> jwtService
userService --> userRepository
userService --> emailService
userService --> auditService
jwtService --> tokenBlacklist
jwtService --> auditService
emailService --> notificationService
userRepository --> [Database]
@enduml
----

=== External System Connections and Integrations

The Identity Provider system integrates with the following external systems:
- **Email System**: For sending notifications and welcome emails.
- **Audit System**: For logging security events and system access.

=== Component Interaction Overview

Components interact primarily through service layers managed by Spring's dependency injection. `UserController` handles all incoming HTTP requests and interacts with `UserService` for user data operations and `JWTService` for authentication tokens.

=== Technology Stack and Frameworks Used

- **Programming Language**: Java
- **Framework**: Spring Boot
- **Security**: Spring Security, JWT
- **Database**: MySQL
- **Others**: Hibernate ORM, JPA

== Component Description

=== IdentityproviderApplication

The entry point of the application, responsible for bootstrapping and starting the Spring Boot application.

=== JwtAuthFilter

A filter that intercepts HTTP requests to validate JWT tokens for secured endpoints.

=== SecurityConfig

Configures security aspects of the application, such as CORS, CSRF, session management, and method-level security.

=== UserController

Handles all user-related operations exposed via REST endpoints. It interacts with `UserService` for user management and `JWTService` for token operations.

=== UserService

Manages all business logic related to user data, including interactions with the `UserRepository` for database operations.

=== JWTService

Responsible for creating, parsing, and validating JWT tokens. It collaborates with `AuditService` for logging token-related activities.

=== AuditService, EmailService, NotificationService

These services handle logging, email notifications, and general notifications, respectively, integrating with external systems as necessary.

=== UserRepository

Spring Data JPA repository for CRUD operations on the `User` entity.

== Infrastructure Architecture

=== Deployment Architecture

The application is containerized using Docker, facilitating deployment on Kubernetes for orchestration.

=== Database Architecture

MySQL is used as the relational database, with entities such as `User`, `Role`, `Token`, and `Client` managed by Hibernate ORM.

=== Security Architecture

Utilizes Spring Security for authentication and authorization, with JWT for stateless session management. Passwords are stored as bcrypt hashes.

=== Network Architecture

The application is deployed within a VPC with restricted access, only exposing necessary ports via a load balancer.

== System Context

=== External Systems and Their Interfaces

- **Email System**: Interface via SMTP for sending emails.
- **Audit System**: RESTful or gRPC interfaces for logging events.

=== Data Flow Between Systems

User data flows from the `UserController` to `UserService` and then to `UserRepository` and the database. Authentication data flows through `JwtAuthFilter` and `JWTService`.

=== Authentication and Authorization Flows at System Level

Authentication is handled via JWT tokens issued at login. Authorization is managed by Spring Security, using roles and permissions stored in the database associated with each user.

This architecture document provides a detailed overview of the Identity Provider system, ensuring all team members and stakeholders have a clear understanding of the system's design and functionality.
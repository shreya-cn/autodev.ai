= Identity Provider Service Architecture Design

This document provides a comprehensive architecture design for the Identity Provider Service, detailing the service architecture, component descriptions, infrastructure, and system context.

== 1. Service Architecture Overview

=== High-level System Architecture Diagram

[plantuml, diagram-arch, png]
----
@startuml
package "Identity Provider Application" {
  [IdentityproviderApplication] as App
  [SecurityConfig] as SecConfig
  [UserController] as UserCtrl
}

package "Security" {
  [JwtAuthFilter] as JwtFilter
  [UserDetailsService] as UserDetailsSvc
  [AuthenticationManager] as AuthManager
}

package "Data Model" {
  [User]
  [Role]
  [Client]
  [Token]
}

package "Persistence" {
  [UserRepository] as UserRepo
}

package "Services" {
  [UserService] as UserSvc
  [JWTService] as JWT
  [AuditService] as AuditSvc
  [EmailService] as EmailSvc
  [NotificationService] as NotificationSvc
  [TokenBlacklistService] as TokenBlacklistSvc
}

App --> SecConfig
SecConfig --> JwtFilter
SecConfig --> UserDetailsSvc
SecConfig --> AuthManager
UserCtrl --> AuthManager
UserCtrl --> JWT
UserCtrl --> UserSvc

UserSvc --> UserRepo
UserSvc --> AuditSvc
UserSvc --> EmailSvc
UserSvc --> UserDetailsSvc

JWT --> AuditSvc
JWT --> TokenBlacklistSvc

UserRepo ..> User
UserRepo ..> Role
UserRepo ..> Client
UserRepo ..> Token

User --> Role
Token --> User
Token --> Client

@enduml
----

=== External System Connections and Integrations

The Identity Provider Service integrates with the following external systems:
- **Email System**: For sending registration and notification emails.
- **Notification Service**: For sending real-time user notifications.

=== Component Interaction Overview

Components interact primarily through Spring-managed beans. `UserController` handles incoming HTTP requests and interacts with `AuthenticationManager` and `JWTService` for authentication and token operations. `UserService` manages user data access and business logic, interfacing with `UserRepository` for data persistence.

=== Technology Stack and Frameworks Used

- **Spring Boot**: Framework for creating stand-alone, production-grade Spring based applications.
- **Spring Security**: For authentication and access-control features.
- **JWT**: For JSON Web Token handling.
- **Hibernate**: For ORM-based data access.
- **MySQL**: As the database backend.
- **Maven**: For project management and build.

== 2. Component Description

=== IdentityproviderApplication

- **Responsibility**: Bootstraps the Spring Boot application.
- **Role**: Entry point of the application, responsible for configuration and startup.
- **Interaction**: Initializes all other components.

=== JwtAuthFilter

- **Responsibility**: Filters incoming requests to check for valid JSON Web Tokens.
- **Role**: Ensures that only authenticated requests proceed to the controller.
- **Interaction**: Interacts with `UserService` to validate user details.

=== SecurityConfig

- **Responsibility**: Configures security-related aspects like authentication and authorization.
- **Role**: Defines beans for `AuthenticationManager`, `AuthenticationProvider`, and `SecurityFilterChain`.
- **Interaction**: Uses `JwtAuthFilter` and `UserDetailsService` to secure the application.

=== UserController

- **Responsibility**: Handles all user-related HTTP requests.
- **Role**: Processes login, registration, and token refresh requests.
- **Interaction**: Uses `AuthenticationManager`, `JWTService`, and `UserService` to perform operations.

=== UserService

- **Responsibility**: Manages all operations related to user data.
- **Role**: Provides methods to load user details and register users.
- **Interaction**: Interacts with `UserRepository`, `AuditService`, and `EmailService`.

== 3. Infrastructure Architecture

=== Deployment Architecture

The application is containerized using Docker, allowing it to be deployed on any Docker-compatible environment, including Kubernetes clusters for better scalability and management.

=== Database Architecture

Uses MySQL as the database with tables for `Users`, `Roles`, `Clients`, and `Tokens`. Hibernate ORM is used for database operations.

=== Security Architecture

Utilizes Spring Security for authentication and authorization. Passwords are stored in hashed formats using BCrypt. JWT tokens are used for maintaining user sessions.

=== Network Architecture

The application is deployed within a VPC with restricted access. Only the HTTP and HTTPS ports are exposed, and access to the database is restricted to the application itself.

== 4. System Context

=== External Systems and Their Interfaces

- **Email System**: Interface for sending emails through SMTP.
- **Notification Service**: REST API for sending notifications.

=== Data Flow Between Systems

User data flows from the `UserController` to the `UserService` and then to the `UserRepository`. Authentication data flows from the `UserController` to the `AuthenticationManager` and `JWTService`.

=== Authentication and Authorization Flows at System Level

Authentication is initiated at the `UserController`, which interacts with `AuthenticationManager` to validate user credentials. Upon successful authentication, `JWTService` generates a token that is used for subsequent requests.

This architecture document provides a detailed overview of the Identity Provider Service, ensuring that architects and senior developers can understand and extend the system as required.
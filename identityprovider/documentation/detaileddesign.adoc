= Identity Provider Detailed Design Documentation

This document provides a comprehensive detailed design of the Identity Provider application, focusing on the Java Spring Boot implementation. It includes class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions.

== Class-by-Class Analysis

=== IdentityproviderApplication

This class serves as the entry point for the Spring Boot application.

- *Annotations*:
  - `@SpringBootApplication`: Marks this class as a Spring Boot application.

- *Methods*:
  - `public static void main(String[] args)`: Launches the Spring Boot application.

=== JwtAuthFilter

This class is responsible for JWT authentication filtering.

- *Annotations*:
  - `@Autowired`: Automatically injects the required dependencies.
  - `@Component`: Marks this class as a Spring-managed component.
  - `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.
  - `@Slf4j`: Provides a logger for this class.

- *Methods*:
  - `protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException`: Filters incoming requests and checks for valid JWT tokens.

- *Fields*:
  - `userService : UserService`: A service for user-related operations.

=== SecurityConfig

Configures security-related aspects of the application.

- *Annotations*:
  - `@Autowired`: Automatically injects the required dependencies.
  - `@Bean`: Indicates that a method produces a bean to be managed by the Spring container.
  - `@Configuration`: Indicates that the class has @Bean definition methods.
  - `@EnableWebSecurity`: Enables Spring Security's web security support.

- *Methods*:
  - `public AuthenticationManager authenticationManager(final AuthenticationConfiguration authConfig) throws Exception`: Configures the authentication manager.
  - `public AuthenticationProvider authenticationProvider()`: Provides a custom authentication provider.
  - `public SecurityFilterChain securityFilterChain(final HttpSecurity http) throws Exception`: Defines security filter chain.

- *Fields*:
  - `jwtAuthFilter : JwtAuthFilter`: JWT authentication filter.
  - `userDetailsService : UserDetailsService`: Service to load user-specific data.

=== UserController

Handles user-related HTTP requests.

- *Annotations*:
  - `@Autowired`: Automatically injects the required dependencies.
  - `@PostMapping`: Handles HTTP POST requests.
  - `@RequestBody`: Indicates a method parameter should be bound to the body of the HTTP request.
  - `@RequestMapping`: Maps HTTP requests to handler methods.
  - `@RestController`: Marks the class as a controller where every method returns a domain object instead of a view.

- *Methods*:
  - `public ResponseEntity<Object> login(@RequestBody final User user)`: Handles user login.
  - `public ResponseEntity<Object> refreshToken(@RequestBody User user)`: Handles token refresh.
  - `public User registerUser(@RequestBody final User user)`: Registers a new user.

- *Fields*:
  - `authManager : AuthenticationManager`: Authentication manager for security.
  - `jwtService : JWTService`: Service for JWT operations.
  - `userService : UserService`: Service for user-related operations.

=== AuthRequest

Data transfer object for authentication requests.

- *Annotations*:
  - `@Data`: Lombok annotation to create all the getters, setters, equals, hash, and toString methods, based on the fields.

- *Fields*:
  - `password : String`: User's password.
  - `username : String`: User's username.

=== AuthResponse

Data transfer object for authentication responses.

=== UserPrincipal

Provides user details for security purposes, implementing Spring Security's UserDetails interface.

- *Annotations*:
  - `@Override`: Indicates overriding a method.

- *Methods*:
  - `public Collection<? extends GrantedAuthority> getAuthorities()`: Returns the authorities granted to the user.
  - `public String getPassword()`: Returns the user's hashed password.
  - `public String getUsername()`: Returns the username used to authenticate the user.
  - `public boolean isAccountNonExpired()`: Indicates whether the user's account has expired.
  - `public boolean isAccountNonLocked()`: Indicates whether the user is locked or unlocked.
  - `public boolean isCredentialsNonExpired()`: Indicates whether the user's credentials (password) has expired.
  - `public boolean isEnabled()`: Indicates whether the user is enabled or disabled.

- *Fields*:
  - `user : final User`: The user entity associated with this principal.

=== Client

Represents a client entity in the system.

- *Annotations*:
  - `@Column`: Specifies the mapped column for a persistent property.
  - `@Entity`: Specifies that the class is an entity.
  - `@GeneratedValue`: Provides for the specification of generation strategies for the values of primary keys.
  - `@Getter`: Lombok annotation to generate the getter methods for the fields.
  - `@Id`: Specifies the primary key of an entity.
  - `@Setter`: Lombok annotation to generate the setter methods for the fields.
  - `@Table`: Specifies the primary table for the annotated entity.

- *Fields*:
  - `clientName : String`: The name of the client.
  - `clientSecret : String`: The secret used for client authentication.
  - `id : Long`: The unique identifier for the client.
  - `redirectUri : String`: The URI to redirect to after a successful login.

=== Role

Represents a role entity in the system.

- *Annotations*:
  - `@Column`: Specifies the mapped column for a persistent property.
  - `@Entity`: Specifies that the class is an entity.
  - `@GeneratedValue`: Provides for the specification of generation strategies for the values of primary keys.
  - `@Id`: Specifies the primary key of an entity.
  - `@ManyToMany`: Defines a many-to-many relationship between the entities.
  - `@Table`: Specifies the primary table for the annotated entity.

- *Methods*:
  - `public Long getId()`: Gets the role's ID.
  - `public Set<User> getUsers()`: Gets the users associated with this role.
  - `public String getName()`: Gets the name of the role.
  - `public void setId(Long id)`: Sets the role's ID.
  - `public void setName(String name)`: Sets the name of the role.
  - `public void setUsers(Set<User> users)`: Sets the users associated with this role.

- *Fields*:
  - `id : Long`: The unique identifier for the role.
  - `name : String`: The name of the role.
  - `users : Set<User>`: The users that have this role.

=== Token

Represents a token entity in the system.

- *Annotations*:
  - `@Column`: Specifies the mapped column for a persistent property.
  - `@Entity`: Specifies that the class is an entity.
  - `@GeneratedValue`: Provides for the specification of generation strategies for the values of primary keys.
  - `@Getter`: Lombok annotation to generate the getter methods for the fields.
  - `@Id`: Specifies the primary key of an entity.
  - `@JoinColumn`: Specifies a column for joining an entity association or element collection.
  - `@ManyToOne`: Defines a many-to-one relationship between the entities.
  - `@Setter`: Lombok annotation to generate the setter methods for the fields.
  - `@Table`: Specifies the primary table for the annotated entity.

- *Fields*:
  - `accessToken : String`: The access token issued to the client.
  - `client : Client`: The client to which the token is issued.
  - `id : Long`: The unique identifier for the token.
  - `refreshToken : String`: The refresh token issued to the client.
  - `user : User`: The user to whom the token is issued.

=== User

Represents a user entity in the system.

- *Annotations*:
  - `@Column`: Specifies the mapped column for a persistent property.
  - `@Data`: Lombok annotation to create all the getters, setters, equals, hash, and toString methods, based on the fields.
  - `@Entity`: Specifies that the class is an entity.
  - `@GeneratedValue`: Provides for the specification of generation strategies for the values of primary keys.
  - `@Getter`: Lombok annotation to generate the getter methods for the fields.
  - `@Id`: Specifies the primary key of an entity.
  - `@JoinColumn`: Specifies a column for joining an entity association or element collection.
  - `@JoinTable`: Specifies the table that is used for the mapping of associations.
  - `@ManyToMany`: Defines a many-to-many relationship between the entities.
  - `@Setter`: Lombok annotation to generate the setter methods for the fields.
  - `@Table`: Specifies the primary table for the annotated entity.

- *Fields*:
  - `email : String`: The user's email address.
  - `id : Long`: The unique identifier for the user.
  - `passwordHash : String`: The hashed password of the user.
  - `roles : Set<Role>`: The roles assigned to the user.
  - `username : String`: The username of the user.

=== UserRepository

Repository for performing database operations on `User` entities.

- *Annotations*:
  - `@Repository`: Indicates that the class is a repository, which encapsulates the logic required to access data sources.

=== AuditService

Service for logging audit events.

- *Annotations*:
  - `@Service`: Marks the class as a Spring service.

- *Methods*:
  - `public void logEvent(String event)`: Logs an audit event.

=== EmailService

Service for sending emails.

- *Annotations*:
  - `@Service`: Marks the class as a Spring service.

- *Methods*:
  - `public void sendWelcomeEmail(String to)`: Sends a welcome email to the specified address.

- *Fields*:
  - `notificationService : final NotificationService`: Service for sending notifications.

=== JWTService

Service for handling JWT operations.

- *Annotations*:
  - `@Service`: Marks the class as a Spring service.
  - `@Slf4j`: Provides a logger for this class.

- *Methods*:
  - `public String extractUsername(String token)`: Extracts the username from the given token.
  - `public String generateToken(final String username)`: Generates a token for the given username.
  - `public boolean validateToken(String token)`: Validates the given token.
  - `public void invalidateToken(String token)`: Invalidates the given token.

- *Fields*:
  - `auditService : final AuditService`: Service for logging audit events.
  - `secretKey : final Key`: The secret key used for token generation and validation.
  - `tokenBlacklistService : final Token Blacklist Service`: Service for blacklisting tokens.

=== NotificationService

Service for sending notifications.

- *Annotations*:
  - `@Service`: Marks the class as a Spring service.

- *Methods*:
  - `public void notifyUser(String user, String message)`: Sends a notification to the specified user.

=== TokenBlacklistService

Service for blacklisting tokens.

- *Annotations*:
  - `@Service`: Marks the class as a Spring service.

- *Methods*:
  - `public void blacklistToken(String token)`: Adds the given token to the blacklist.

=== UserService

Service for user-related operations.

- *Annotations*:
  - `@Autowired`: Automatically injects the required dependencies.
  - `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.
  - `@Service`: Marks the class as a Spring service.

- *Methods*:
  - `public UserDetails loadUserByUsername(final String username) throws UsernameNotFoundException`: Loads the user details by username.
  - `public User register(final User user)`: Registers a new user.

- *Fields*:
  - `auditService : AuditService`: Service for logging audit events.
  - `emailService : EmailService`: Service for sending emails.
  - `encoder : BCryptPasswordEncoder`: Encoder for password hashing.
  - `userRepository : UserRepository`: Repository for performing database operations on `User` entities.

=== IdentityproviderApplicationTests

Class for performing tests on the Identity Provider application.

- *Annotations*:
  - `@SpringBootTest`: Indicates that the class should bootstrap with Spring Boot's support.
  - `@Test`: Indicates that the method is a test method.

== Runtime View Diagrams

=== Sequence Diagrams

The following sequence diagrams illustrate key business flows using PlantUML.

==== User Registration Flow

```plantuml
@startuml
actor Client
boundary UserController
control UserService
database UserRepository

Client -> UserController : register(user)
UserController -> UserService : register(user)
UserService -> UserRepository : save(user)
UserRepository -> UserService : user
UserService -> UserController : user
UserController -> Client : user
@enduml
```

==== Authentication/Login Flow

```plantuml
@startuml
actor Client
boundary UserController
control UserService
database UserRepository

Client -> UserController : login(authRequest)
UserController -> UserService : loadUserByUsername(username)
UserService -> UserRepository : findByUsername(username)
UserRepository -> UserService : user
UserService -> UserController : userDetails
UserController -> Client : authResponse
@enduml
```

==== JWT Token Validation Flow

```plantuml
@startuml
actor Client
boundary JwtAuthFilter
control JWTService

Client -> JwtAuthFilter : request(resource)
JwtAuthFilter -> JWTService : validateToken(token)
JWTService -> JwtAuthFilter : isValid
JwtAuthFilter -> Client : proceed / error
@enduml
```

==== Business Process Flow

```plantuml
@startuml
actor Client
boundary UserController
control UserService
control JWTService
database UserRepository

Client -> UserController : login(authRequest)
UserController -> UserService : loadUserByUsername(username)
UserService -> UserRepository : findByUsername(username)
UserRepository -> UserService : user
UserService -> JWTService : generateToken(username)
JWTService -> UserService : token
UserService -> UserController : authResponse(token)
UserController -> Client : authResponse
@enduml
```

==== Exception Handling Flow

```plantuml
@startuml
actor Client
boundary UserController
control UserService
database UserRepository

Client -> UserController : login(authRequest)
alt valid user
  UserController -> UserService : loadUserByUsername(username)
  UserService -> UserRepository : findByUsername(username)
  UserRepository -> UserService : user
  UserService -> UserController : userDetails
  UserController -> Client : authResponse
else invalid user
  UserController -> Client : errorResponse("User not found")
end
@enduml
```

== Entity Relationship Diagram

The following ER diagram illustrates the relationships between entities using PlantUML.

```plantuml
@startuml
entity "User" {
  * id : Long
  --
  * username : String
  * email : String
  * passwordHash : String
  --
  * roles : Set<Role>
}

entity "Role" {
  * id : Long
  --
  * name : String
  --
  * users : Set<User>
}

entity "Client" {
  * id : Long
  --
  * clientName : String
  * clientSecret : String
  * redirectUri : String
}

entity "Token" {
  * id : Long
  --
  * accessToken : String
  * refreshToken : String
  --
  * user : User
  * client : Client
}

User "1" -- "*" Role
Role "1" -- "*" User
User "1" -- "*" Token
Client "1" -- "*" Token
@enduml
```

=== Detailed Description of Entities and Relationships

- **User**: Represents a user in the system. Each user has a unique ID, a username, an email, and a hashed password. Users are associated with roles and tokens.
  - **Fields**:
    - `id`: The unique identifier for the user.
    - `username`: The username of the user.
    - `email`: The email address of the user.
    - `passwordHash`: The hashed password of the user.
  - **Relationships**:
    - `roles`: A many-to-many relationship with the `Role` entity. Users can have multiple roles, and roles can be assigned to multiple users.
    - `tokens`: A one-to-many relationship with the `Token` entity. Users can have multiple tokens issued to them.

- **Role**: Represents a role in the system. Each role has a unique ID and a name. Roles are associated with users.
  - **Fields**:
    - `id`: The unique identifier for the role.
    - `name`: The name of the role.
  - **Relationships**:
    - `users`: A many-to-many relationship with the `User` entity. Roles can be assigned to multiple users, and users can have multiple roles.

- **Client**: Represents a client in the system. Each client has a unique ID, a name, a secret, and a redirect URI. Clients are associated with tokens.
  - **Fields**:
    - `id`: The unique identifier for the client.
    - `clientName`: The name of the client.
    - `clientSecret`: The secret used for client authentication.
    - `redirectUri`: The URI to redirect to after a successful login.
  - **Relationships**:
    - `tokens`: A one-to-many relationship with the `Token` entity. Clients can have multiple tokens issued to them.

- **Token**: Represents a token in the system. Each token has a unique ID, an access token, and a refresh token. Tokens are associated with users and clients.
  - **Fields**:
    - `id`: The unique identifier for the token.
    - `accessToken`: The access token issued to the client.
    - `refreshToken`: The refresh token issued to the client.
  - **Relationships**:
    - `user`: A many-to-one relationship with the `User` entity. Each token is issued to a specific user.
    - `client`: A many-to-one relationship with the `Client` entity. Each token is issued by a specific client.

== Detailed Component Interactions

=== Controller-Service-Repository Interactions

- **UserController**:
  - Interacts with `UserService` to perform user-related operations such as registration and login.
  - Receives data from clients and sends responses back to clients.
  - Uses `JWTService` to handle JWT creation and validation during the login process.

- **UserService**:
  - Interacts with `UserRepository` to perform database operations related to users.
  - Uses services like `EmailService` and `AuditService` to perform operations related to email sending and auditing.
  - Handles business logic related to user management, such as user registration and loading user details.

- **JWTService**:
  - Handles all JWT-related operations, including token generation, extraction, validation, and invalidation.
  - Interacts with `TokenBlacklistService` to check and update the status of blacklisted tokens.

=== Data Flow Through Layers

- Data flows from the controller layer to the service layer, where business logic is applied. From
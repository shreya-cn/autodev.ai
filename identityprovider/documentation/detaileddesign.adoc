= Identity Provider Detailed Design Documentation

This document provides a comprehensive detailed design for the Identity Provider application, covering class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions.

== 1. Class-by-Class Analysis

=== IdentityproviderApplication

*Purpose*: Serves as the entry point of the Spring Boot application.

*Methods*:
- `public static void main(String[] args)`: Boots up the Spring Boot application.

*Annotations*:
- `@SpringBootApplication`: Indicates that this class serves as the Spring Boot application configuration.

=== JwtAuthFilter

*Purpose*: Filters incoming requests to check for a valid JSON Web Token (JWT).

*Methods*:
- `protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException`: Filters requests to ensure they contain a valid JWT.

*Annotations*:
- `@Autowired`: Automatically injects the required dependencies.
- `@Component`: Marks the class as a Spring component.
- `@Override`: Indicates that a superclass method is overridden.
- `@Slf4j`: Provides a logger for this class.

*Fields*:
- `userService : UserService`: Dependency to interact with user-related operations.

=== SecurityConfig

*Purpose*: Configures security settings for the application, including authentication and authorization.

*Methods*:
- `AuthenticationManager authenticationManager(AuthenticationConfiguration authConfig)`: Configures the authentication manager.
- `AuthenticationProvider authenticationProvider()`: Provides a custom authentication provider.
- `SecurityFilterChain securityFilterChain(HttpSecurity http)`: Defines security rules for HTTP requests.

*Annotations*:
- `@Autowired`: Injects dependencies automatically.
- `@Bean`: Marks a method to return a bean managed by Spring.
- `@Configuration`: Indicates that the class has @Bean definition methods.
- `@EnableWebSecurity`: Enables Spring Security's web security support.

*Fields*:
- `jwtAuthFilter : JwtAuthFilter`: The JWT authentication filter.
- `userDetailsService : UserDetailsService`: Service to load user-specific data.

=== UserController

*Purpose*: Handles all user-related HTTP requests.

*Methods*:
- `login(@RequestBody final User user)`: Authenticates a user and returns a JWT.
- `refreshToken(@RequestBody User user)`: Refreshes an expired JWT.
- `registerUser(@RequestBody final User user)`: Registers a new user in the system.

*Annotations*:
- `@Autowired`: Injects dependencies automatically.
- `@PostMapping`: Maps HTTP POST requests onto specific handler methods.
- `@RequestBody`: Indicates a method parameter should be bound to the body of the HTTP request.
- `@RequestMapping`: Maps HTTP requests to handler methods of MVC and REST controllers.
- `@RestController`: Marks the class as a controller where every method returns a domain object instead of a view.

*Fields*:
- `authManager : AuthenticationManager`: Manages authentication processes.
- `jwtService : JWTService`: Handles operations related to JWT.
- `userService : UserService`: Manages user-related business logic.

=== AuthRequest

*Purpose*: Represents an authentication request containing username and password.

*Annotations*:
- `@Data`: Generates boilerplate code for this class (getters, setters, etc.).

*Fields*:
- `password : String`: The user's password.
- `username : String`: The user's username.

=== AuthResponse

*Purpose*: Represents the response returned after a successful authentication.

*Fields*: None.

=== UserPrincipal

*Purpose*: Custom implementation of UserDetails to support authentication processes.

*Methods*:
- Implements methods from `UserDetails` interface to provide user information to Spring Security.

*Fields*:
- `user : final User`: The user data.

=== Client

*Purpose*: Represents a client application that can request tokens.

*Annotations*:
- `@Entity`: Marks the class as a JPA entity.
- `@Table`: Specifies the table in the database for this entity.

*Fields*:
- `clientName : String`: The name of the client.
- `clientSecret : String`: The secret used for client authentication.
- `id : Long`: The primary key.
- `redirectUri : String`: URI to redirect after authentication.

=== Role

*Purpose*: Represents roles that can be granted to users.

*Annotations*:
- `@Entity`: Marks the class as a JPA entity.
- `@Table`: Specifies the table in the database for this entity.

*Methods*:
- Getters and setters for the entity's fields.

*Fields*:
- `id : Long`: The primary key.
- `name : String`: The name of the role.
- `users : Set<User>`: The users that are granted this role.

=== Token

*Purpose*: Represents an authentication token.

*Annotations*:
- `@Entity`: Marks the class as a JPA entity.
- `@Table`: Specifies the table in the database for this entity.

*Fields*:
- `accessToken : String`: The access token.
- `client : Client`: The client to which this token is issued.
- `id : Long`: The primary key.
- `refreshToken : String`: The refresh token.
- `user : User`: The user to whom the token is issued.

=== User

*Purpose*: Represents a user in the system.

*Annotations*:
- `@Entity`: Marks the class as a JPA entity.
- `@Table`: Specifies the table in the database for this entity.

*Fields*:
- `email : String`: The user's email address.
- `id : Long`: The primary key.
- `passwordHash : String`: The hash of the user's password.
- `roles : Set<Role>`: The roles assigned to the user.
- `username : String`: The user's username.

=== UserRepository

*Purpose*: Repository interface for user-related database operations.

*Annotations*:
- `@Repository`: Marks the interface as a repository in Spring, eligible for Spring Data exception translation.

=== AuditService

*Purpose*: Provides functionality to log audit events.

*Methods*:
- `logEvent(String event)`: Logs an audit event.

*Annotations*:
- `@Service`: Marks the class as a business service facade.

=== EmailService

*Purpose*: Manages email operations.

*Methods*:
- `sendWelcomeEmail(String to)`: Sends a welcome email to a new user.

*Annotations*:
- `@Service`: Marks the class as a business service facade.

*Fields*:
- `notificationService : final NotificationService`: Dependency for notification services.

=== JWTService

*Purpose*: Manages JWT creation and validation.

*Methods*:
- `extractUsername(String token)`: Extracts the username from a JWT.
- `generateToken(final String username)`: Generates a new JWT for a given username.
- `validateToken(String token)`: Validates a JWT.
- `invalidateToken(String token)`: Invalidates a JWT.

*Annotations*:
- `@Service`: Marks the class as a business service facade.
- `@Slf4j`: Provides logging capability.

*Fields*:
- `auditService : final AuditService`: Dependency for audit services.
- `secretKey : final Key`: The key used for signing JWTs.
- `tokenBlacklistService : final TokenBlacklistService`: Service to blacklist tokens.

=== NotificationService

*Purpose*: Manages user notifications.

*Methods*:
- `notifyUser(String user, String message)`: Sends a notification to a user.

*Annotations*:
- `@Service`: Marks the class as a business service facade.

=== TokenBlacklistService

*Purpose*: Provides functionality to blacklist tokens.

*Methods*:
- `blacklistToken(String token)`: Adds a token to the blacklist.

*Annotations*:
- `@Service`: Marks the class as a business service facade.

=== UserService

*Purpose*: Manages user-related business logic.

*Methods*:
- `loadUserByUsername(final String username)`: Loads user details by username.
- `register(final User user)`: Registers a new user.

*Annotations*:
- `@Autowired`: Injects dependencies automatically.
- `@Override`: Indicates that a superclass method is overridden.
- `@Service`: Marks the class as a business service facade.

*Fields*:
- `auditService : AuditService`: Dependency for audit services.
- `emailService : EmailService`: Dependency for email services.
- `encoder : BCryptPasswordEncoder`: Encoder for password hashing.
- `userRepository : UserRepository`: Repository for user data access.

=== IdentityproviderApplicationTests

*Purpose*: Contains tests for the Identity Provider application.

*Annotations*:
- `@SpringBootTest`: Indicates that the class should bootstrap the application for integration tests.
- `@Test`: Marks methods as test methods.

== 2. Runtime View Diagrams

=== User Registration Flow

[plantuml, user-registration-sequence, png]
----
@startuml
actor User
participant UserController
participant UserService
participant UserRepository
participant EmailService

User -> UserController : register(user)
UserController -> UserService : register(user)
UserService -> UserRepository : save(user)
UserRepository -> UserService : userSaved
UserService -> EmailService : sendWelcomeEmail(user.email)
EmailService -> UserService : emailSent
UserService -> UserController : user
UserController -> User : user
@enduml
----

=== Authentication/Login Flow

[plantuml, authentication-sequence, png]
----
@startuml
actor User
participant UserController
participant UserService
participant JWTService

User -> UserController : login(authRequest)
UserController -> UserService : loadUserByUsername(authRequest.username)
UserService -> UserController : userPrincipal
UserController -> JWTService : generateToken(userPrincipal.username)
JWTService -> UserController : token
UserController -> User : token
@enduml
----

=== JWT Token Validation Flow

[plantuml, jwt-validation-sequence, png]
----
@startuml
actor User
participant JwtAuthFilter
participant JWTService

User -> JwtAuthFilter : request(resource)
JwtAuthFilter -> JWTService : validateToken(token)
JWTService -> JwtAuthFilter : isValid
JwtAuthFilter -> User : proceed / error
@enduml
----

=== Exception Handling Flow

[plantuml, exception-handling-sequence, png]
----
@startuml
actor User
participant UserController
participant UserService
participant ErrorHandlingComponent

User -> UserController : action()
alt success
  UserController -> UserService : performAction()
  UserService -> UserController : result
  UserController -> User : result
else exception
  UserController -> ErrorHandlingComponent : handleException(e)
  ErrorHandlingComponent -> UserController : errorResponse
  UserController -> User : errorResponse
end
@enduml
----

== 3. Entity Relationship Diagram

[plantuml, entity-relationship-diagram, png]
----
@startuml
entity "User" {
  *id : Long
  *username : String
  *email : String
  *passwordHash : String
  --
  +roles : Set<Role>
}

entity "Role" {
  *id : Long
  *name : String
  --
  +users : Set<User>
}

entity "Client" {
  *id : Long
  *clientName : String
  *clientSecret : String
  *redirectUri : String
}

entity "Token" {
  *id : Long
  *accessToken : String
  *refreshToken : String
  --
  +user : User
  +client : Client
}

User ||--o{ Role : has
Role ||--o{ User : belongs to
User ||--o{ Token : owns
Client ||--o{ Token : issues
@enduml
----

=== Entity Descriptions

- **User**: Represents a user in the system with a unique ID, username, email, and a hashed password. Users are associated with roles that grant them permissions.
- **Role**: Represents a security role with a unique ID and name. Roles are associated with multiple users.
- **Client**: Represents a client application with a unique ID, name, secret, and redirect URI. Clients can request tokens for users.
- **Token**: Represents an authentication or refresh token associated with a user and the client that requested the token. Each token has a unique ID, access token string, and refresh token string.

== 4. Detailed Component Interactions

=== Controller-Service-Repository Interactions

- **UserController** interacts with **UserService** to handle user registration, login, and token refresh operations.
- **UserService** uses **UserRepository** to access and store user data. It also interacts with **EmailService** to send welcome emails upon user registration.
- **JwtAuthFilter** uses **JWTService** to validate tokens in incoming requests.

=== Data Flow Through Layers

- Data flows from the controllers to services where business logic is applied. Services interact with repositories to persist or retrieve data. Services may also interact with other services like email or notification services to perform operations beyond simple CRUD.

=== Exception Propagation

- Exceptions are caught in controllers and handled by a centralized exception handling component which constructs appropriate error responses based on the exception type.

=== Transaction Boundaries

- Transactions are typically started at the service layer to ensure data integrity and consistency across operations involved in a business process. For instance, during user registration, transactions ensure that both the user record is saved and a welcome email is sent atomically.

This detailed design document provides a thorough overview of the Identity Provider application, enabling developers to understand and contribute to the project effectively.
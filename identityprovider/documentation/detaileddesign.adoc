= Detailed Design Documentation for Identity Provider Application

This document provides a comprehensive detailed design of the Identity Provider Application developed using Java Spring Boot. It includes class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions.

== Class-by-Class Analysis

=== IdentityproviderApplication

*Purpose:* Serves as the entry point for the Spring Boot application.

*Annotations:*
- `@SpringBootApplication`: Indicates that this is a Spring Boot application.

*Methods:*
- `public static void main(String[] args)`: Launches the Spring Boot application.

=== JwtAuthFilter

*Purpose:* Filter to handle JWT authentication.

*Annotations:*
- `@Autowired`: Automatically injects the required dependencies.
- `@Component`: Marks the class as a Spring component.
- `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.
- `@Slf4j`: Provides a logger for logging.

*Methods:*
- `protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException`: Filters incoming requests and checks for valid JWT tokens.

*Fields:*
- `userService : UserService`: Service used for user-related operations.

=== SecurityConfig

*Purpose:* Configuration for security aspects of the application.

*Annotations:*
- `@Autowired`: Automatically injects the required dependencies.
- `@Bean`: Indicates that a method produces a bean to be managed by the Spring container.
- `@Configuration`: Indicates that the class has @Bean definition methods.
- `@EnableWebSecurity`: Enables Spring Security's web security support.

*Methods:*
- `public AuthenticationManager authenticationManager(final AuthenticationConfiguration authConfig) throws Exception`: Configures the authentication manager.
- `public AuthenticationProvider authenticationProvider()`: Defines the authentication provider.
- `public SecurityFilterChain securityFilterChain(final HttpSecurity http) throws Exception`: Configures the security filter chain.

*Fields:*
- `jwtAuthFilter : JwtAuthFilter`: JWT authentication filter.
- `userDetailsService : UserDetailsService`: Service to load user-specific data.

=== UserController

*Purpose:* Controller to handle user-related HTTP requests.

*Annotations:*
- `@Autowired`: Automatically injects the required dependencies.
- `@PostMapping`: Annotation for mapping HTTP POST requests onto specific handler methods.
- `@RequestBody`: Annotation indicating a method parameter should be bound to the body of the HTTP request.
- `@RequestMapping`: Annotation for mapping web requests onto methods in request-handling classes.
- `@RestController`: Indicates that the data returned by each method will be written straight into the response body instead of rendering a template.

*Methods:*
- `public ResponseEntity<Object> login(@RequestBody final User user)`: Handles user login.
- `public ResponseEntity<Object> refreshToken(@RequestBody User user)`: Handles refresh token generation.
- `public User registerUser(@RequestBody final User user)`: Handles user registration.

*Fields:*
- `authManager : AuthenticationManager`: Authentication manager for handling authentication.
- `jwtService : JWTService`: Service for JWT operations.
- `userService : UserService`: Service for user operations.

=== AuthRequest

*Purpose:* Represents an authentication request.

*Annotations:*
- `@Data`: Lombok annotation to create all the getters, setters, equals, hash, and toString methods, based on the fields.

*Fields:*
- `password : String`: User's password.
- `username : String`: User's username.

=== AuthResponse

*Purpose:* Represents an authentication response.

=== UserPrincipal

*Purpose:* Principal object representing a user.

*Annotations:*
- `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.

*Methods:*
- `public Collection<? extends GrantedAuthority> getAuthorities()`: Returns the authorities granted to the user.
- `public String getPassword()`: Returns the user's hashed password.
- `public String getUsername()`: Returns the username.
- `public boolean isAccountNonExpired()`: Checks if the account is non-expired.
- `public boolean isAccountNonLocked()`: Checks if the account is non-locked.
- `public boolean isCredentialsNonExpired()`: Checks if the credentials are non-expired.
- `public boolean isEnabled()`: Checks if the user is enabled.

*Fields:*
- `user : final User`: User details.

=== Client

*Purpose:* Entity representing a client application.

*Annotations:*
- `@Column`: Specifies the mapped column for a persistent property or field.
- `@Entity`: Specifies that the class is an entity.
- `@GeneratedValue`: Provides for the specification of generation strategies for the values of primary keys.
- `@Getter`: Lombok annotation to generate getter.
- `@Id`: Specifies the primary key of an entity.
- `@Setter`: Lombok annotation to generate setter.
- `@Table`: Specifies the primary table for the annotated entity.

*Fields:*
- `clientName : String`: Name of the client.
- `clientSecret : String`: Secret used for client authentication.
- `id : Long`: Primary key.
- `redirectUri : String`: URI to redirect after authentication.

=== Role

*Purpose:* Entity representing a user role.

*Annotations:*
- `@Column`: Specifies the mapped column for a persistent property or field.
- `@Entity`: Specifies that the class is an entity.
- `@GeneratedValue`: Provides for the specification of generation strategies for the values of primary keys.
- `@Id`: Specifies the primary key of an entity.
- `@ManyToMany`: Defines a many-to-many relationship between the join Entities.
- `@Table`: Specifies the primary table for the annotated entity.

*Methods:*
- `public Long getId()`: Returns the role ID.
- `public Set<User> getUsers()`: Returns the users with this role.
- `public String getName()`: Returns the role name.
- `public void setId(Long id)`: Sets the role ID.
- `public void setName(String name)`: Sets the role name.
- `public void setUsers(Set<User> users)`: Sets the users with this role.

*Fields:*
- `id : Long`: Primary key.
- `name : String`: Name of the role.
- `users : Set<User>`: Users having this role.

=== Token

*Purpose:* Entity representing an authentication token.

*Annotations:*
- `@Column`: Specifies the mapped column for a persistent property or field.
- `@Entity`: Specifies that the class is an entity.
- `@GeneratedValue`: Provides for the specification of generation strategies for the values of primary keys.
- `@Getter`: Lombok annotation to generate getter.
- `@Id`: Specifies the primary key of an entity.
- `@JoinColumn`: Specifies a column for joining an entity association or element collection.
- `@ManyToOne`: Defines a many-to-one relationship between the join Entities.
- `@Setter`: Lombok annotation to generate setter.
- `@Table`: Specifies the primary table for the annotated entity.

*Fields:*
- `accessToken : String`: Access token string.
- `client : Client`: Associated client.
- `id : Long`: Primary key.
- `refreshToken : String`: Refresh token string.
- `user : User`: Associated user.

=== User

*Purpose:* Entity representing a user.

*Annotations:*
- `@Column`: Specifies the mapped column for a persistent property or field.
- `@Data`: Lombok annotation to create all the getters, setters, equals, hash, and toString methods, based on the fields.
- `@Entity`: Specifies that the class is an entity.
- `@GeneratedValue`: Provides for the specification of generation strategies for the values of primary keys.
- `@Getter`: Lombok annotation to generate getter.
- `@Id`: Specifies the primary key of an entity.
- `@JoinColumn`: Specifies a column for joining an entity association or element collection.
- `@JoinTable`: Specifies the table that is used for the mapping of associations.
- `@ManyToMany`: Defines a many-to-many relationship between the join Entities.
- `@Setter`: Lombok annotation to generate setter.
- `@Table`: Specifies the primary table for the annotated entity.

*Fields:*
- `email : String`: Email of the user.
- `id : Long`: Primary key.
- `passwordHash : String`: Hashed password.
- `roles : Set<Role>`: Roles assigned to the user.
- `username : String`: Username.

=== UserRepository

*Purpose:* Repository for handling CRUD operations related to users.

*Annotations:*
- `@Repository`: Indicates that the class is a repository.

=== AuditService

*Purpose:* Service for auditing events.

*Annotations:*
- `@Service`: Indicates that the class is a service.

*Methods:*
- `public void logEvent(String event)`: Logs an audit event.

=== EmailService

*Purpose:* Service for sending emails.

*Annotations:*
- `@Service`: Indicates that the class is a service.

*Methods:*
- `public void sendWelcomeEmail(String to)`: Sends a welcome email.

*Fields:*
- `notificationService : final NotificationService`: Service for sending notifications.

=== JWTService

*Purpose:* Service for handling JWT operations.

*Annotations:*
- `@Service`: Indicates that the class is a service.
- `@Slf4j`: Provides a logger for logging.

*Methods:*
- `public String extractUsername(String token)`: Extracts the username from the token.
- `public String generateToken(final String username)`: Generates a token for the specified username.
- `public boolean validateToken(String token)`: Validates the specified token.
- `public void invalidateToken(String token)`: Invalidates the specified token.

*Fields:*
- `auditService : final AuditService`: Audit service for logging events.
- `secretKey : final Key`: Secret key used for token generation.
- `tokenBlacklistService : final TokenBlacklistService`: Service for blacklisting tokens.

=== NotificationService

*Purpose:* Service for sending notifications.

*Annotations:*
- `@Service`: Indicates that the class is a service.

*Methods:*
- `public void notifyUser(String user, String message)`: Sends a notification to the user.

=== TokenBlacklistService

*Purpose:* Service for blacklisting tokens.

*Annotations:*
- `@Service`: Indicates that the class is a service.

*Methods:*
- `public void blacklistToken(String token)`: Blacklists the specified token.

=== UserService

*Purpose:* Service for handling user-related operations.

*Annotations:*
- `@Autowired`: Automatically injects the required dependencies.
- `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.
- `@Service`: Indicates that the class is a service.

*Methods:*
- `public UserDetails loadUserByUsername(final String username) throws UsernameNotFoundException`: Loads user details by username.
- `public User register(final User user)`: Registers a new user.

*Fields:*
- `auditService : AuditService`: Service for auditing events.
- `emailService : EmailService`: Service for sending emails.
- `encoder : BCryptPasswordEncoder`: Encoder for hashing passwords.
- `userRepository : UserRepository`: Repository for user CRUD operations.

=== IdentityproviderApplicationTests

*Purpose:* Class for testing the Identity Provider Application.

*Annotations:*
- `@SpringBootTest`: Indicates that the class is a Spring Boot test.
- `@Test`: Indicates that the method is a test method.

== Runtime View Diagrams

=== User Registration Flow

```plantuml
@startuml
actor User
participant UserController
participant UserService
participant UserRepository
participant EmailService
participant AuditService

User -> UserController : register(user)
UserController -> UserService : register(user)
UserService -> UserRepository : save(user)
UserRepository --> UserService : user
UserService -> EmailService : sendWelcomeEmail(user.email)
EmailService --> UserService
UserService -> AuditService : logEvent("User registered")
AuditService --> UserService
UserService --> UserController : user
UserController --> User : user
@enduml
```

=== Authentication/Login Flow

```plantuml
@startuml
actor User
participant UserController
participant UserService
participant JWTService
participant AuditService

User -> UserController : login(authRequest)
UserController -> UserService : loadUserByUsername(authRequest.username)
UserService --> UserController : userDetails
UserController -> JWTService : generateToken(userDetails.username)
JWTService --> UserController : token
UserController -> AuditService : logEvent("User logged in")
AuditService --> UserController
UserController --> User : token
@enduml
```

=== JWT Token Validation Flow

```plantuml
@startuml
actor User
participant JwtAuthFilter
participant JWTService
participant AuditService

User -> JwtAuthFilter : request(resource)
JwtAuthFilter -> JWTService : validateToken(token)
JWTService --> JwtAuthFilter : isValid
alt isValid
    JwtAuthFilter -> AuditService : logEvent("Token validated")
    AuditService --> JwtAuthFilter
    JwtAuthFilter --> User : proceed
else not isValid
    JwtAuthFilter -> AuditService : logEvent("Invalid token")
    AuditService --> JwtAuthFilter
    JwtAuthFilter --> User : error(response)
end
@enduml
```

=== Business Process Flows

*Note:* Detailed business process flows would be similar to the above, tailored to specific business operations.

=== Exception Handling Flows

```plantuml
@startuml
actor User
participant UserController
participant UserService
participant AuditService

User -> UserController : request(action)
alt success
    UserController -> UserService : performAction()
    UserService --> UserController : result
    UserController --> User : result
else exception
    UserController -> AuditService : logEvent("Exception occurred")
    AuditService --> UserController
    UserController --> User : error(response)
end
@enduml
```

== Entity Relationship Diagram

```plantuml
@startuml
entity User {
    * id : Long
    * username : String
    * email : String
    * passwordHash : String
    --
    * roles : Set<Role>
}

entity Role {
    * id : Long
    * name : String
    --
    * users : Set<User>
}

entity Client {
    * id : Long
    * clientName : String
    * clientSecret : String
    * redirectUri : String
}

entity Token {
    * id : Long
    * accessToken : String
    * refreshToken : String
    --
    * user : User
    * client : Client
}

User "1" -- "0..*" Role
Role "1" -- "0..*" User
User "1" -- "0..*" Token
Client "1" -- "0..*" Token
@enduml
```

=== Detailed Description of Entities and Relationships

- **User:** Represents the users of the system. Each user has a unique ID, a username, an email, and a hashed password. Users are associated with roles and tokens.
- **Role:** Represents roles that can be assigned to users. Each role has a unique ID and a name. Roles are associated with multiple users.
- **Client:** Represents client applications that can request tokens. Each client has a unique ID, a name, a secret for authentication, and a redirect URI.
- **Token:** Represents authentication and refresh tokens issued to users. Each token has a unique ID, an access token string, and a refresh token string. Tokens are associated with a user and a client.

== Detailed Component Interactions

=== Controller-Service-Repository Interactions

- **UserController** interacts with **UserService** to handle user-related operations such as registration and login.
- **UserService** uses **UserRepository** to perform CRUD operations on the User entity.
- **UserService** also interacts with **EmailService** and **AuditService** to send emails and log events, respectively.

=== Data Flow Through Layers

- Data flows from controllers to services where business logic is executed. Services interact with repositories to fetch or persist data. Services may also call other services like email or audit services.

=== Exception Propagation

- Exceptions are typically thrown by services or repositories and are caught in controllers where an appropriate HTTP response is generated.

=== Transaction Boundaries

- Transactions are managed at the service layer, ensuring that database operations are completed successfully before committing the transaction.

This detailed design document provides a comprehensive overview of the Identity Provider Application, enabling developers to understand and contribute to the project effectively.
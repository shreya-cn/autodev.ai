= Detailed Design Documentation for Identity Provider Application

This document provides a comprehensive detailed design overview of the Identity Provider application, focusing on its Java Spring Boot implementation. It includes class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions.

== Class-by-Class Analysis

=== IdentityproviderApplication

[source,java]
----
@SpringBootApplication
public class IdentityproviderApplication {
    public static void main(String[] args) {
        SpringApplication.run(IdentityproviderApplication.class, args);
    }
}
----

*Purpose:* Serves as the entry point for the Spring Boot application. It initializes and configures the application context.

*Annotations:*
- `@SpringBootApplication`: Indicates a configuration class that declares one or more `@Bean` methods and also triggers auto-configuration and component scanning.

=== JwtAuthFilter

[source,java]
----
@Component
@Slf4j
public class JwtAuthFilter extends OncePerRequestFilter {
    @Autowired
    private UserService userService;

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {
        // Implementation details
    }
}
----

*Purpose:* Filters incoming requests to validate JWT tokens.

*Methods:*
- `doFilterInternal`: Validates the JWT token from the request headers.

*Annotations:*
- `@Component`: Indicates that the class is a Spring component.
- `@Slf4j`: Provides a logger instance.

=== SecurityConfig

[source,java]
----
@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Autowired
    private JwtAuthFilter jwtAuthFilter;

    @Autowired
    private UserDetailsService userDetailsService;

    @Bean
    public AuthenticationManager authenticationManager(AuthenticationConfiguration authConfig) throws Exception {
        return authConfig.getAuthenticationManager();
    }

    @Bean
    public AuthenticationProvider authenticationProvider() {
        // Implementation details
    }

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        // Implementation details
    }
}
----

*Purpose:* Configures security settings for the application, including authentication and authorization mechanisms.

*Methods:*
- `authenticationManager`: Provides the default authentication manager.
- `authenticationProvider`: Configures a custom authentication provider.
- `securityFilterChain`: Defines security rules and filters for HTTP requests.

*Annotations:*
- `@Configuration`: Indicates that the class is a source of bean definitions.
- `@EnableWebSecurity`: Enables Spring Security's web security support.

=== UserController

[source,java]
----
@RestController
@RequestMapping("/idp/users")
public class UserController {

    @Autowired
    private AuthenticationManager authManager;

    @Autowired
    private JWTService jwtService;

    @Autowired
    private UserService userService;

    @PostMapping("/register")
    public User registerUser(@RequestBody final User user) {
        return userService.register(user);
    }

    @PostMapping("/login")
    public ResponseEntity<Object> login(@RequestBody final User user) {
        // Implementation details
    }

    @PostMapping("/refreshtoken")
    public ResponseEntity<Object> refreshToken(@RequestBody User user) {
        // Implementation details
    }
}
----

*Purpose:* Handles user-related operations such as registration, login, and token refresh.

*Methods:*
- `registerUser`: Registers a new user.
- `login`: Authenticates a user and generates a JWT.
- `refreshToken`: Refreshes an existing JWT.

*Annotations:*
- `@RestController`: Marks the class as a controller where every method returns a domain object instead of a view.
- `@RequestMapping`: Maps HTTP requests to handler methods of MVC and REST controllers.
- `@PostMapping`: Annotation for mapping HTTP POST requests onto specific handler methods.

== Runtime View Diagrams

=== User Registration Flow

[plantuml, user-registration-sequence, png]
----
@startuml
actor User
participant UserController
participant UserService
participant UserRepository

User -> UserController : register(user)
UserController -> UserService : register(user)
UserService -> UserRepository : save(user)
UserRepository -> UserService : user
UserService -> UserController : user
UserController -> User : user
@enduml
----

=== Authentication/Login Flow

[plantuml, authentication-sequence, png]
----
@startuml
actor User
participant UserController
participant AuthenticationManager
participant JWTService

User -> UserController : login(authRequest)
UserController -> AuthenticationManager : authenticate(authRequest)
AuthenticationManager -> UserController : authentication
UserController -> JWTService : generateToken(authentication.principal)
JWTService -> UserController : token
UserController -> User : token
@enduml
----

=== JWT Token Validation Flow

[plantuml, jwt-validation-sequence, png]
----
@startuml
actor User
participant JwtAuthFilter
participant JWTService

User -> JwtAuthFilter : request(with JWT)
JwtAuthFilter -> JWTService : validateToken(JWT)
JWTService -> JwtAuthFilter : isValid
JwtAuthFilter -> User : proceed / block
@enduml
----

== Entity Relationship Diagram

[plantuml, er-diagram, png]
----
@startuml
entity User {
    * id : Long
    * username : String
    * passwordHash : String
    * email : String
    --
    * roles : Set<Role>
}

entity Role {
    * id : Long
    * name : String
    --
    * users : Set<User>
}

entity Client {
    * id : Long
    * clientName : String
    * clientSecret : String
    * redirectUri : String
}

entity Token {
    * id : Long
    * accessToken : String
    * refreshToken : String
    --
    * user : User
    * client : Client
}

User "1" -- "0..*" Role : has >
Role "1" -- "0..*" User : belongs to >
User "1" -- "0..*" Token : has >
Client "1" -- "0..*" Token : issued >
@enduml
----

*User:* Represents a user of the system with their credentials and roles.
*Role:* Represents security roles associated with users.
*Client:* Represents an OAuth client with its secret and redirect URI.
*Token:* Represents an OAuth access and refresh token associated with a user and client.

== Detailed Component Interactions

=== Controller-Service-Repository Interactions

1. *UserController* interacts with *UserService* to handle user-related operations.
2. *UserService* uses *UserRepository* to persist and retrieve user data.
3. *JwtAuthFilter* uses *JWTService* for token validation.

=== Data Flow Through Layers

1. HTTP requests are received by *Controllers*.
2. *Controllers* delegate business logic execution to *Services*.
3. *Services* interact with *Repositories* for data persistence.

=== Exception Propagation

Exceptions are thrown by lower layers (e.g., Repositories, Services) and are handled or propagated up to the Controllers where they are transformed into appropriate HTTP responses.

=== Transaction Boundaries

Transactions are typically started at the service layer to encompass a complete business operation, ensuring data integrity and consistency.

This detailed design document provides a thorough overview for developers to understand and implement the specified functionalities in the Identity Provider application.
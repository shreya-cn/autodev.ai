= Identity Provider Detailed Design Documentation

This document provides a comprehensive detailed design for the Identity Provider application, including class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions.

== Class-by-Class Analysis

=== IdentityproviderApplication

*Purpose*: Serves as the entry point for the Spring Boot application.

*Methods*:
- `public static void main(String[] args)`: Bootstraps the Spring Boot application.

*Annotations*:
- `@SpringBootApplication`: Indicates a configuration class that declares one or more `@Bean` methods and also triggers auto-configuration and component scanning.

=== JwtAuthFilter

*Purpose*: Filter to intercept requests and perform JWT token validation.

*Methods*:
- `protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException`: Intercepts the request, validates the JWT token, and either forwards the request or handles the authentication error.

*Annotations*:
- `@Autowired`: Marks a dependency to be injected by Spring.
- `@Component`: Indicates that the class is a Spring-managed component.
- `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.
- `@Slf4j`: Lombok annotation to enable logging.

*Fields*:
- `userService : UserService`: Dependency to manage user-related operations.

=== SecurityConfig

*Purpose*: Configuration for security aspects of the application, such as authentication and authorization.

*Methods*:
- `public AuthenticationManager authenticationManager(final AuthenticationConfiguration authConfig) throws Exception`: Configures the authentication manager.
- `public AuthenticationProvider authenticationProvider()`: Provides a custom authentication provider.
- `public SecurityFilterChain securityFilterChain(final HttpSecurity http) throws Exception`: Defines security rules and filters.

*Annotations*:
- `@Autowired`: Marks a dependency to be injected.
- `@Bean`: Indicates that a method produces a bean to be managed by the Spring container.
- `@Configuration`: Indicates that the class has `@Bean` definition methods.
- `@EnableWebSecurity`: Enables Spring Security's web security support.

*Fields*:
- `jwtAuthFilter : JwtAuthFilter`: JWT authentication filter.
- `userDetailsService : UserDetailsService`: Service to load user-specific data.

=== UserController

*Purpose*: Controller to handle user-related operations such as registration and login.

*Methods*:
- `public ResponseEntity<Object> login(@RequestBody final User user)`: Handles user login.
- `public ResponseEntity<Object> refreshToken(@RequestBody User user)`: Generates a new JWT token.
- `public User registerUser(@RequestBody final User user)`: Registers a new user.

*Annotations*:
- `@Autowired`: Marks a dependency to be injected.
- `@PostMapping`: Annotation for mapping HTTP POST requests onto specific handler methods.
- `@RequestBody`: Indicates a method parameter should be bound to the body of the HTTP request.
- `@RequestMapping`: Annotation for mapping web requests onto methods in request-handling classes.
- `@RestController`: Indicates that the data returned by each method will be written straight into the response body instead of rendering a template.

*Fields*:
- `authManager : AuthenticationManager`: Manages authentication processes.
- `jwtService : JWTService`: Service to handle JWT operations.
- `userService : UserService`: Service to manage user data.

=== AuthRequest

*Purpose*: Data transfer object to handle authentication requests.

*Fields*:
- `password : String`: User's password.
- `username : String`: User's username.

*Annotations*:
- `@Data`: Lombok annotation to generate getters, setters, toString, equals, and hashCode methods.

=== AuthResponse

*Purpose*: Data transfer object to handle responses after authentication.

=== UserPrincipal

*Purpose*: Principal object representing a user.

*Methods*:
- Implements methods from `UserDetails` interface to provide user information to Spring Security.

*Annotations*:
- `@Override`: Indicates overriding a method.

*Fields*:
- `user : final User`: The user object.

=== Client

*Purpose*: Entity representing an OAuth client.

*Annotations*:
- `@Column`: Specifies the mapped column for a persistent property.
- `@Entity`: Specifies that the class is an entity.
- `@GeneratedValue`: Provides for the specification of generation strategies for the values of primary keys.
- `@Getter`: Lombok annotation to generate the getter method.
- `@Id`: Specifies the primary key of an entity.
- `@Setter`: Lombok annotation to generate the setter method.
- `@Table`: Specifies the primary table for the annotated entity.

*Fields*:
- `clientName : String`: Name of the client.
- `clientSecret : String`: Secret used for client authentication.
- `id : Long`: Primary key.
- `redirectUri : String`: URI to redirect after authentication.

=== Role

*Purpose*: Entity representing a user role.

*Methods*:
- Standard getters and setters.

*Annotations*:
- `@Column`: Specifies the mapped column.
- `@Entity`: Marks the class as an entity.
- `@GeneratedValue`: Specifies the generation strategy.
- `@Id`: Marks a field as the primary key.
- `@ManyToMany`: Defines a many-to-many relationship.
- `@Table`: Specifies the table.

*Fields*:
- `id : Long`: Primary key.
- `name : String`: Name of the role.
- `users : Set<User>`: Users having this role.

=== Token

*Purpose*: Entity representing an authentication token.

*Annotations*:
- `@Column`: Specifies the mapped column.
- `@Entity`: Marks the class as an entity.
- `@GeneratedValue`: Specifies the generation strategy.
- `@Getter`: Generates the getter method.
- `@Id`: Marks a field as the primary key.
- `@JoinColumn`: Specifies a column for joining an entity association.
- `@ManyToOne`: Defines a many-to-one relationship.
- `@Setter`: Generates the setter method.
- `@Table`: Specifies the table.

*Fields*:
- `accessToken : String`: Access token string.
- `client : Client`: Associated client.
- `id : Long`: Primary key.
- `refreshToken : String`: Refresh token string.
- `user : User`: Associated user.

=== User

*Purpose*: Entity representing a user.

*Annotations*:
- `@Column`: Specifies the mapped column.
- `@Data`: Lombok annotation to generate various methods.
- `@Entity`: Marks the class as an entity.
- `@GeneratedValue`: Specifies the generation strategy.
- `@Getter`: Generates the getter method.
- `@Id`: Marks a field as the primary key.
- `@JoinColumn`: Specifies a column for joining an entity association.
- `@JoinTable`: Specifies a join table for a many-to-many association.
- `@ManyToMany`: Defines a many-to-many relationship.
- `@Setter`: Generates the setter method.
- `@Table`: Specifies the table.

*Fields*:
- `email : String`: User's email.
- `id : Long`: Primary key.
- `passwordHash : String`: Hashed password.
- `roles : Set<Role>`: Roles assigned to the user.
- `username : String`: Username.

=== UserRepository

*Purpose*: Repository for accessing `User` entities.

*Annotations*:
- `@Repository`: Indicates that the class is a repository.

=== AuditService

*Purpose*: Service for logging audit events.

*Methods*:
- `public void logEvent(String event)`: Logs an audit event.

*Annotations*:
- `@Service`: Indicates that the class is a service.

=== EmailService

*Purpose*: Service for sending emails.

*Methods*:
- `public void sendWelcomeEmail(String to)`: Sends a welcome email to the specified address.

*Annotations*:
- `@Service`: Indicates that the class is a service.

*Fields*:
- `notificationService : final NotificationService`: Service for sending notifications.

=== JWTService

*Purpose*: Service for handling JWT operations.

*Methods*:
- `public String extractUsername(String token)`: Extracts the username from the token.
- `public String generateToken(final String username)`: Generates a JWT token for the specified username.
- `public boolean validateToken(String token)`: Validates the specified token.
- `public void invalidateToken(String token)`: Invalidates the specified token.

*Annotations*:
- `@Service`: Indicates that the class is a service.
- `@Slf4j`: Enables logging.

*Fields*:
- `auditService : final AuditService`: Service for logging audit events.
- `secretKey : final Key`: The secret key used for signing tokens.
- `tokenBlacklistService : final Token Blacklist Service`: Service for managing blacklisted tokens.

=== NotificationService

*Purpose*: Service for sending notifications.

*Methods*:
- `public void notifyUser(String user, String message)`: Sends a notification to the specified user.

*Annotations*:
- `@Service`: Indicates that the class is a service.

=== TokenBlacklistService

*Purpose*: Service for managing blacklisted tokens.

*Methods*:
- `public void blacklistToken(String token)`: Adds a token to the blacklist.

*Annotations*:
- `@Service`: Indicates that the class is a service.

=== UserService

*Purpose*: Service for managing user data.

*Methods*:
- `public UserDetails loadUserByUsername(final String username) throws UsernameNotFoundException`: Loads user details by username.
- `public User register(final User user)`: Registers a new user.

*Annotations*:
- `@Autowired`: Marks a dependency to be injected.
- `@Override`: Indicates overriding a method.
- `@Service`: Indicates that the class is a service.

*Fields*:
- `auditService : AuditService`: Service for logging audit events.
- `emailService : EmailService`: Service for sending emails.
- `encoder : BCryptPasswordEncoder`: Encoder for hashing passwords.
- `userRepository : UserRepository`: Repository for accessing user data.

=== IdentityproviderApplicationTests

*Purpose*: Contains tests for the Identity Provider application.

*Annotations*:
- `@SpringBootTest`: Indicates that the class should bootstrap the application for integration tests.
- `@Test`: Indicates that the method is a test method.

== Runtime View Diagrams

=== User Registration Flow

[plantuml, user-registration-sequence, png]
----
@startuml
actor User
participant "UserController" as UC
participant "UserService" as US
participant "UserRepository" as UR
participant "EmailService" as ES

User -> UC : register(user)
UC -> US : register(user)
US -> UR : save(user)
UR --> US : user
US -> ES : sendWelcomeEmail(user.email)
ES --> US : emailSent
US --> UC : user
UC --> User : user
@enduml
----

=== Authentication/Login Flow

[plantuml, authentication-sequence, png]
----
@startuml
actor User
participant "UserController" as UC
participant "UserService" as US
participant "JWTService" as JS

User -> UC : login(authRequest)
UC -> US : loadUserByUsername(authRequest.username)
US --> UC : userDetails
UC -> JS : generateToken(userDetails.username)
JS --> UC : token
UC --> User : token
@enduml
----

=== JWT Token Validation Flow

[plantuml, jwt-validation-sequence, png]
----
@startuml
actor User
participant "JwtAuthFilter" as JF
participant "JWTService" as JS

User -> JF : request(resource)
JF -> JS : validateToken(token)
JS --> JF : isValid
alt isValid
    JF -> JF : forward(request)
else notValid
    JF -> JF : errorResponse
end
JF --> User : response
@enduml
----

=== Exception Handling Flow

[plantuml, exception-handling-sequence, png]
----
@startuml
actor User
participant "UserController" as UC
participant "UserService" as US
participant "ExceptionHandling" as EH

User -> UC : action()
UC -> US : process()
US -> US : validate()
alt validation fails
    US -> EH : handleException()
    EH --> US : errorResponse
    US --> UC : errorResponse
    UC --> User : errorResponse
else validation succeeds
    US --> UC : success
    UC --> User : success
end
@enduml
----

== Entity Relationship Diagram

[plantuml, er-diagram, png]
----
@startuml
entity "User" as User {
    *id : Long
    --
    *username : String
    *passwordHash : String
    *email : String
    roles : Set<Role>
}

entity "Role" as Role {
    *id : Long
    --
    *name : String
    users : Set<User>
}

entity "Client" as Client {
    *id : Long
    --
    *clientName : String
    *clientSecret : String
    *redirectUri : String
}

entity "Token" as Token {
    *id : Long
    --
    *accessToken : String
    *refreshToken : String
    user : User
    client : Client
}

User "1" -- "0..*" Role : has >
Role "0..*" -- "1" User : belongs to <
User "1" -- "0..*" Token : has >
Token "0..1" -- "1" User : belongs to <
Token "0..1" -- "1" Client : belongs to <
@enduml
----

== Detailed Component Interactions

=== Controller-Service-Repository Interactions

*UserController* -> *UserService*:
- UserController calls UserService to handle business logic related to user operations (e.g., registration, login).

*UserService* -> *UserRepository*:
- UserService interacts with UserRepository to perform CRUD operations on the User entity.

=== Data Flow Through Layers

1. *Controller Layer*: Receives HTTP requests and delegates business processing to the service layer.
2. *Service Layer*: Handles business logic and interacts with the repository layer for data access.
3. *Repository Layer*: Performs database operations.

=== Exception Propagation

Exceptions are thrown from the repository or service layers and are caught in the controller layer where appropriate error responses are generated.

=== Transaction Boundaries

Transactions are typically started at the service layer to ensure data integrity and rollback capabilities in case of errors during business operations.

== Conclusion

This detailed design document provides a comprehensive overview of the Identity Provider application, including class responsibilities, interactions, and data flows. The inclusion of sequence diagrams and an ER diagram aids in understanding the overall architecture and operation flows. This document should serve as a valuable resource for developers involved in maintaining or enhancing this application.
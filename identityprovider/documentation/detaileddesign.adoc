= Identity Provider Detailed Design Documentation

This document provides a comprehensive detailed design of the Identity Provider application built using Java Spring Boot. It includes class-by-class analysis, runtime view diagrams with PlantUML, entity relationship diagrams, and detailed component interactions.

== 1. Class-by-Class Analysis

=== IdentityproviderApplication

*Purpose:* Serves as the entry point for the Spring Boot application.

*Methods:*
- `public static void main(String[] args)`: Bootstraps the Spring Boot application.

*Annotations:*
- `@SpringBootApplication`: Indicates a configuration class that declares one or more `@Bean` methods and also triggers auto-configuration and component scanning.

=== JwtAuthFilter

*Purpose:* Filters incoming requests and manages authentication using JWT tokens.

*Methods:*
- `protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException`: Filters requests to check for the presence of a valid JWT token.

*Annotations:*
- `@Autowired`: Marks dependency injection.
- `@Component`: Indicates that an annotated class is a "component".
- `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.
- `@Slf4j`: Embeds the logger capability.

*Fields:*
- `userService : UserService`: Injected to use functionalities provided by the UserService.

=== SecurityConfig

*Purpose:* Configuration for security aspects of the application, such as authentication and authorization.

*Methods:*
- `AuthenticationManager authenticationManager(AuthenticationConfiguration authConfig)`: Defines the authentication manager bean.
- `AuthenticationProvider authenticationProvider()`: Defines the authentication provider bean.
- `SecurityFilterChain securityFilterChain(HttpSecurity http)`: Configures the security filter chain.

*Annotations:*
- `@Autowired`: Marks dependency injection.
- `@Bean`: Indicates that a method produces a bean to be managed by the Spring container.
- `@Configuration`: Indicates that the class has `@Bean` definition methods.
- `@EnableWebSecurity`: Adds Spring Security configuration.

*Fields:*
- `jwtAuthFilter : JwtAuthFilter`: JWT authentication filter.
- `userDetailsService : UserDetailsService`: Service to load user-specific data.

=== UserController

*Purpose:* Controller to manage user-related operations such as registration and login.

*Methods:*
- `login(User user)`: Handles user login.
- `refreshToken(User user)`: Refreshes the authentication token.
- `registerUser(User user)`: Registers a new user.

*Annotations:*
- `@Autowired`: Marks dependency injection.
- `@PostMapping`: Mapping HTTP POST requests onto specific handler methods.
- `@RequestBody`: Indicates a method parameter should be bound to the body of the HTTP request.
- `@RequestMapping`: Provides routing information.
- `@RestController`: Marks the class as a controller where every method returns a domain object instead of a view.

*Fields:*
- `authManager : AuthenticationManager`: Manages authentication.
- `jwtService : JWTService`: Service for JWT operations.
- `userService : UserService`: Service for user-related operations.

=== AuthRequest

*Purpose:* DTO for authentication request data.

*Fields:*
- `password : String`: User's password.
- `username : String`: User's username.

*Annotations:*
- `@Data`: A Lombok annotation to create all the getters, setters, equals, hash, and toString methods, based on the fields.

=== AuthResponse

*Purpose:* DTO for authentication response data.

=== UserPrincipal

*Purpose:* Principal object representing a user.

*Methods:*
- Implements methods from `UserDetails` interface such as `getAuthorities()`, `getPassword()`, `getUsername()`, `isAccountNonExpired()`, `isAccountNonLocked()`, `isCredentialsNonExpired()`, and `isEnabled()`.

*Annotations:*
- `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.

*Fields:*
- `user : final User`: The user data.

=== Client

*Purpose:* Entity representing an OAuth client.

*Annotations:*
- `@Entity`: Specifies that the class is an entity.
- `@Table`: Specifies the table in the database for this entity.
- `@Id`: Specifies the primary key.
- `@GeneratedValue`: Provides the specification of generation strategies for the values of primary keys.
- `@Column`: Specifies the mapped column for a persistent property or field.
- `@Getter`: Lombok annotation to generate getters.
- `@Setter`: Lombok annotation to generate setters.

*Fields:*
- `clientName : String`: Name of the client.
- `clientSecret : String`: Secret key for the client.
- `id : Long`: Unique identifier for the client.
- `redirectUri : String`: URI to redirect after authentication.

=== Role

*Purpose:* Entity representing a user role.

*Annotations:*
- `@Entity`: Specifies that the class is an entity.
- `@Table`: Specifies the table in the database for this entity.
- `@Id`: Specifies the primary key.
- `@GeneratedValue`: Provides the specification of generation strategies for the values of primary keys.
- `@Column`: Specifies the mapped column for a persistent property or field.
- `@ManyToMany`: Defines a many-to-many relationship between the entities.

*Methods:*
- `getId()`, `setId(Long id)`: Getter and setter for `id`.
- `getName()`, `setName(String name)`: Getter and setter for `name`.
- `getUsers()`, `setUsers(Set<User> users)`: Getter and setter for `users`.

*Fields:*
- `id : Long`: Unique identifier for the role.
- `name : String`: Name of the role.
- `users : Set<User>`: Users associated with this role.

=== Token

*Purpose:* Entity representing an authentication token.

*Annotations:*
- `@Entity`: Specifies that the class is an entity.
- `@Table`: Specifies the table in the database for this entity.
- `@Id`: Specifies the primary key.
- `@GeneratedValue`: Provides the specification of generation strategies for the values of primary keys.
- `@Column`: Specifies the mapped column for a persistent property or field.
- `@ManyToOne`: Defines a many-to-one relationship between the entities.
- `@JoinColumn`: Specifies a column for joining an entity association.
- `@Getter`: Lombok annotation to generate getters.
- `@Setter`: Lombok annotation to generate setters.

*Fields:*
- `accessToken : String`: The access token.
- `client : Client`: The client associated with this token.
- `id : Long`: Unique identifier for the token.
- `refreshToken : String`: The refresh token.
- `user : User`: The user associated with this token.

=== User

*Purpose:* Entity representing a user.

*Annotations:*
- `@Entity`: Specifies that the class is an entity.
- `@Table`: Specifies the table in the database for this entity.
- `@Id`: Specifies the primary key.
- `@GeneratedValue`: Provides the specification of generation strategies for the values of primary keys.
- `@Column`: Specifies the mapped column for a persistent property or field.
- `@ManyToMany`: Defines a many-to-many relationship between the entities.
- `@JoinTable`: Specifies the join table for many-to-many relationships.
- `@Data`: A Lombok annotation to create all the getters, setters, equals, hash, and toString methods, based on the fields.
- `@Getter`: Lombok annotation to generate getters.
- `@Setter`: Lombok annotation to generate setters.

*Fields:*
- `email : String`: Email of the user.
- `id : Long`: Unique identifier for the user.
- `passwordHash : String`: Hashed password of the user.
- `roles : Set<Role>`: Roles associated with the user.
- `username : String`: Username of the user.

=== UserRepository

*Purpose:* Repository for accessing user data from the database.

*Annotations:*
- `@Repository`: Indicates that the class is a repository.

=== AuditService

*Purpose:* Service for logging audit events.

*Methods:*
- `logEvent(String event)`: Logs an audit event.

*Annotations:*
- `@Service`: Indicates that the class is a service.

=== EmailService

*Purpose:* Service for sending emails.

*Methods:*
- `sendWelcomeEmail(String to)`: Sends a welcome email to a new user.

*Annotations:*
- `@Service`: Indicates that the class is a service.

*Fields:*
- `notificationService : final NotificationService`: Service for sending notifications.

=== JWTService

*Purpose:* Service for managing JWT tokens.

*Methods:*
- `extractUsername(String token)`: Extracts username from the token.
- `generateToken(String username)`: Generates a new token.
- `validateToken(String token)`: Validates the token.
- `invalidateToken(String token)`: Invalidates the token.

*Annotations:*
- `@Service`: Indicates that the class is a service.
- `@Slf4j`: Embeds the logger capability.

*Fields:*
- `auditService : final AuditService`: Audit service for logging.
- `secretKey : final Key`: Secret key for token generation.
- `tokenBlacklistService : final TokenBlacklistService`: Service for blacklisting tokens.

=== NotificationService

*Purpose:* Service for sending notifications.

*Methods:*
- `notifyUser(String user, String message)`: Sends a notification to a user.

*Annotations:*
- `@Service`: Indicates that the class is a service.

=== TokenBlacklistService

*Purpose:* Service for blacklisting tokens.

*Methods:*
- `blacklistToken(String token)`: Adds a token to the blacklist.

*Annotations:*
- `@Service`: Indicates that the class is a service.

=== UserService

*Purpose:* Service for user-related operations.

*Methods:*
- `loadUserByUsername(String username)`: Loads user details by username.
- `register(User user)`: Registers a new user.

*Annotations:*
- `@Autowired`: Marks dependency injection.
- `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.
- `@Service`: Indicates that the class is a service.

*Fields:*
- `auditService : AuditService`: Service for auditing.
- `emailService : EmailService`: Service for sending emails.
- `encoder : BCryptPasswordEncoder`: Encoder for password hashing.
- `userRepository : UserRepository`: Repository for accessing user data.

=== IdentityproviderApplicationTests

*Purpose:* Contains tests for the Identity Provider application.

*Annotations:*
- `@SpringBootTest`: Indicates that the class should bootstrap with Spring Boot for integration tests.
- `@Test`: Indicates that the method is a test method.

== 2. Runtime View Diagrams

=== User Registration Flow

[plantuml, user-registration-sequence, png]
----
@startuml
actor User
participant UserController
participant UserService
participant UserRepository
participant EmailService

User -> UserController : register(User)
UserController -> UserService : register(User)
UserService -> UserRepository : save(User)
UserRepository -> UserService : User
UserService -> EmailService : sendWelcomeEmail(User.email)
EmailService -> UserService : EmailSent
UserService -> UserController : User
UserController -> User : User
@enduml
----

=== Authentication/Login Flow

[plantuml, authentication-sequence, png]
----
@startuml
actor User
participant UserController
participant UserService
participant JWTService

User -> UserController : login(AuthRequest)
UserController -> UserService : loadUserByUsername(username)
UserService -> UserController : UserDetails
UserController -> JWTService : generateToken(username)
JWTService -> UserController : JWT
UserController -> User : JWT
@enduml
----

=== JWT Token Validation Flow

[plantuml, jwt-validation-sequence, png]
----
@startuml
actor User
participant JwtAuthFilter
participant JWTService

User -> JwtAuthFilter : Request(JWT)
JwtAuthFilter -> JWTService : validateToken(JWT)
JWTService -> JwtAuthFilter : isValid
JwtAuthFilter -> User : Proceed / Error
@enduml
----

=== Business Process Flow

[plantuml, business-process-sequence, png]
----
@startuml
actor User
participant UserController
participant UserService
participant AuditService

User -> UserController : performAction()
UserController -> UserService : processAction()
UserService -> AuditService : logEvent("Action performed")
AuditService -> UserService : LogSaved
UserService -> UserController : Result
UserController -> User : Result
@enduml
----

=== Exception Handling Flow

[plantuml, exception-handling-sequence, png]
----
@startuml
actor User
participant UserController
participant UserService

User -> UserController : request()
alt success
  UserController -> UserService : process()
  UserService -> UserController : response
  UserController -> User : response
else exception
  UserController -> UserService : handleError()
  UserService -> UserController : errorResponse
  UserController -> User : errorResponse
end
@enduml
----

== 3. Entity Relationship Diagram

[plantuml, er-diagram, png]
----
@startuml
entity User {
  * id : Long
  --
  * username : String
  * email : String
  * passwordHash : String
  --
  * roles : Set<Role>
}

entity Role {
  * id : Long
  --
  * name : String
  --
  * users : Set<User>
}

entity Client {
  * id : Long
  --
  * clientName : String
  * clientSecret : String
  * redirectUri : String
}

entity Token {
  * id : Long
  --
  * accessToken : String
  * refreshToken : String
  --
  * user : User
  * client : Client
}

User "1" -- "0..*" Role : has >
Role "0..*" -- "1" User : belongs to <
User "1" -- "0..*" Token : has >
Token "0..1" -- "1" User : belongs to <
Client "1" -- "0..*" Token : has >
Token "0..1" -- "1" Client : belongs to <
@enduml
----

*Entities and Relationships:*

- **User**: Represents a user in the system. Each user has a unique ID, username, email, and password hash. Users are associated with roles through a many-to-many relationship.
- **Role**: Represents a role that can be assigned to a user. Each role has a unique ID and a name. Roles are associated with users through a many-to-many relationship.
- **Client**: Represents an OAuth client. Each client has a unique ID, name, secret, and redirect URI.
- **Token**: Represents an authentication token linked to a user and client. Each token has a unique ID, access token, and refresh token. It is associated with one user and one client.

== 4. Detailed Component Interactions

=== Controller-Service-Repository Interactions

- **UserController** interacts with **UserService** to handle user-related operations such as registration and login.
- **UserService** uses **UserRepository** to persist user data.
- **UserService** may also interact with **EmailService** to send welcome emails to new users.

=== Data Flow Through Layers

- Data flows from **Controllers** to **Services** where business logic is applied. Then, data is persisted or retrieved from the database through **Repositories**. Finally, the result is sent back to the user through the controllers.

=== Exception Propagation

- Exceptions are typically caught in the **Services** and are either handled or propagated to **Controllers** where an appropriate response is generated and returned to the user.

=== Transaction Boundaries

- Transactions are managed at the service layer, ensuring that database operations either complete successfully or are rolled back in case of an error, maintaining data integrity.

This design document provides a detailed overview of the Identity Provider application, focusing on the architecture, design patterns, and interactions between components. It serves as a guide for developers and architects involved in the development and maintenance of the system.
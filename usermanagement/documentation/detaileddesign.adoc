= User Management System Detailed Design Documentation

This document provides a comprehensive detailed design of the User Management System, developed using Java Spring Boot. It includes a class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions.

== 1. Class-by-Class Analysis

=== 1.1 UsermanagementApplication

*Purpose*: Serves as the entry point for the Spring Boot application.

*Annotations*:
- `@EnableFeignClients`: Enables the discovery and management of Feign clients.
- `@SpringBootApplication`: Indicates a configuration class that declares one or more `@Bean` methods and also triggers auto-configuration and component scanning.

*Methods*:
- `public static void main(String[] args)`: The main method that Spring Boot uses to start the application.

=== 1.2 IdentityProviderClient

*Purpose*: Defines a Feign client for interacting with an external identity provider service.

*Annotations*:
- `@FeignClient`: Declares that this interface is a Feign client.
- `@PostMapping`: Maps HTTP POST requests onto specific handler methods.
- `@RequestBody`: Indicates a method parameter should be bound to the body of the web request.

=== 1.3 VehicleManagementClient

*Purpose*: Feign client for communicating with vehicle management services.

*Annotations*:
- `@FeignClient`: Marks this interface as a Feign client.
- `@GetMapping`: Maps HTTP GET requests onto specific handler methods.
- `@RequestParam`: Indicates a method parameter should be bound to a web request parameter.

=== 1.4 UserManagementController

*Purpose*: Handles all user-related HTTP requests.

*Annotations*:
- `@Autowired`: Marks a field as to be autowired by Spring's dependency injection facilities.
- `@PostMapping`: Maps HTTP POST requests onto specific handler methods.
- `@RequestMapping`: Provides routing information.
- `@RequestParam`: Indicates a method parameter should be bound to a web request parameter.
- `@RestController`: Marks the class as a controller where every method returns a domain object instead of a view.

*Methods*:
- `public String assignVehicle(String username, String vin, String brand, String country)`: Assigns a vehicle to a user.
- `public String onboardUser(String username, String password)`: Onboards a new user.

*Fields*:
- `service : UserManagementService`: Injected service layer handling business logic.

=== 1.5 MobilityUser

*Purpose*: Represents the user entity.

*Annotations*:
- `@Entity`: Specifies that the class is an entity.
- `@GeneratedValue`: Provides for the specification of generation strategies for the values of primary keys.
- `@Getter`: Lombok annotation to generate getters.
- `@Id`: Specifies the primary key of an entity.
- `@Setter`: Lombok annotation to generate setters.
- `@Table`: Specifies the primary table for the annotated entity.

*Fields*:
- `id : Long`: Primary key.
- `mobilityUserId : String`: Unique user identifier.
- `role : String`: User's role.
- `username : String`: Username.
- `vin : String`: Vehicle Identification Number associated with the user.

=== 1.6 UserManagementRepository

*Purpose*: Interface for database operations related to `MobilityUser`.

=== 1.7 UserManagementService

*Purpose*: Service layer managing business logic around user management.

*Annotations*:
- `@Autowired`: Marks a field as to be autowired by Spring's dependency injection facilities.
- `@Service`: Indicates that an annotated class is a "Service".

*Methods*:
- `public Optional<MobilityUser> getUserByUsername(String username)`: Retrieves a user by username.
- `public String onboardUser(String username, String password)`: Handles the logic for user onboarding.
- `public void assignVehicleToUser(String username, String vin, String brand, String country)`: Assigns a vehicle to a user.

*Fields*:
- `identityProvider : IdentityProviderClient`: Feign client for identity provider.
- `repo : UserManagementRepository`: Repository for accessing user data.
- `vehicleClient : Vehicle ManagementClient`: Feign client for vehicle management.

=== 1.8 UsermanagementApplicationTests

*Purpose*: Contains test cases for the application.

*Annotations*:
- `@SpringBootTest`: Provides Spring Boot test features.
- `@Test`: Marks a method as a test method.

== 2. Runtime View Diagrams

=== 2.1 User Registration Flow

[plantuml, user-registration-sequence, png]
----
@startuml
actor User
participant "UserManagementController" as Controller
participant "UserManagementService" as Service
participant "IdentityProviderClient" as IdentityProvider

User -> Controller: onboardUser(username, password)
Controller -> Service: onboardUser(username, password)
Service -> IdentityProvider: createIdentity(username, password)
IdentityProvider -> Service: identityResponse
Service -> Controller: response
Controller -> User: response
@enduml
----

=== 2.2 Authentication/Login Flow

[plantuml, authentication-sequence, png]
----
@startuml
actor User
participant "UserManagementController" as Controller
participant "UserManagementService" as Service
participant "IdentityProviderClient" as IdentityProvider

User -> Controller: authenticateUser(username, password)
Controller -> Service: authenticateUser(username, password)
Service -> IdentityProvider: validateCredentials(username, password)
IdentityProvider -> Service: validationResponse
Service -> Controller: response
Controller -> User: response
@enduml
----

=== 2.3 JWT Token Validation Flow

[plantuml, jwt-validation-sequence, png]
----
@startuml
actor User
participant "UserManagementController" as Controller
participant "UserManagementService" as Service

User -> Controller: validateToken(jwtToken)
Controller -> Service: validateToken(jwtToken)
Service -> Controller: isValid
Controller -> User: isValid
@enduml
----

== 3. Entity Relationship Diagram

[plantuml, er-diagram, png]
----
@startuml
entity "MobilityUser" {
  *id : Long
  --
  *mobilityUserId : String
  *role : String
  *username : String
  *vin : String
}
@enduml
----

*Entity Description*:
- **MobilityUser**: Represents a user in the system. It includes fields for identification, role, username, and associated vehicle identification number (VIN).

== 4. Detailed Component Interactions

=== 4.1 Controller-Service-Repository Interactions

- **UserManagementController**:
  - Receives HTTP requests and delegates to **UserManagementService**.
  - Handles HTTP responses based on the outcomes of service methods.

- **UserManagementService**:
  - Implements the business logic by interacting with **IdentityProviderClient**, **VehicleManagementClient**, and **UserManagementRepository**.
  - Manages data flow between web layer and persistence layer.

- **UserManagementRepository**:
  - Handles CRUD operations directly related to the **MobilityUser** entity.

=== 4.2 Data Flow Through Layers

- Data flows from the controllers to services where business logic is applied. Then, depending on the operation, it might interact with external services via Feign clients or with the database via repositories.

=== 4.3 Exception Propagation

- Exceptions are thrown from the service layer and are caught in the controller layer where appropriate HTTP responses are generated.

=== 4.4 Transaction Boundaries

- Transactions are managed at the service layer, ensuring that database operations are completed successfully before committing the transaction.

This document provides a detailed overview of the User Management System, designed to aid developers in understanding and maintaining the system.
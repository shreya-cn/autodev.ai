= User Management System Detailed Design Documentation

This document provides a comprehensive detailed design overview of the User Management System implemented using Java Spring Boot. It includes class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions.

== Class-by-Class Analysis

=== UsermanagementApplication

This is the main class that boots up the Spring Boot application.

* *Annotations*:
** `@EnableFeignClients`: Enables the discovery of interfaces that declare they are Feign clients.
** `@SpringBootApplication`: Indicates a configuration class that declares one or more `@Bean` methods and also triggers auto-configuration and component scanning.

* *Methods*:
** `public static void main(String[] args)`: The entry point of the Spring Boot application.

=== IdentityProviderClient

This class is a Feign client that communicates with an identity provider service.

* *Annotations*:
** `@FeignClient`: Declares that this interface is a Feign client.
** `@PostMapping`: Used on methods to map HTTP POST requests onto specific handler methods.
** `@RequestBody`: Indicates a method parameter should be bound to the body of the web request.

=== VehicleManagementClient

This class is a Feign client for interacting with a vehicle management service.

* *Annotations*:
** `@FeignClient`: Marks this interface as a Feign client.
** `@GetMapping`: Indicates that a method should handle HTTP GET requests.
** `@RequestParam`: Indicates that a method parameter should be bound to a web request parameter.

=== UserManagementController

This class handles incoming HTTP requests related to user management.

* *Annotations*:
** `@RestController`: Indicates that the data returned by each method will be written straight into the response body instead of rendering a template.
** `@Autowired`: Marks a field as to be autowired by Spring's dependency injection facilities.
** `@PostMapping`: Used to map HTTP POST requests onto specific handler methods.
** `@RequestMapping`: Provides routing information. It tells Spring that any HTTP request with the specified path should be mapped to the corresponding method.

* *Methods*:
** `onboardUser(String username, String password)`: Handles the user onboarding process.
** `assignVehicle(String username, String vin, String brand, String country)`: Assigns a vehicle to a user.

=== MobilityUser

This class represents the user entity.

* *Annotations*:
** `@Entity`: Specifies that the class is an entity and is mapped to a database table.
** `@Table`: Specifies the table in the database with which this entity is mapped.
** `@Id`: Specifies the primary key of an entity.
** `@GeneratedValue`: Provides for the specification of generation strategies for the values of primary keys.
** `@Getter` and `@Setter`: Lombok annotations to automatically generate getters and setters.

* *Fields*:
** `id`: The primary key.
** `mobilityUserId`: A unique identifier for the user.
** `role`: The user's role.
** `username`: The user's username.
** `vin`: Vehicle Identification Number associated with the user.

=== UserManagementRepository

This class is a Spring Data repository for `MobilityUser`.

=== UserManagementService

This class contains business logic related to user management.

* *Annotations*:
** `@Service`: Indicates that an annotated class is a "Service".
** `@Autowired`: Marks a constructor, field, or setter method to be autowired by Spring's dependency injection facilities.

* *Methods*:
** `getUserByUsername(String username)`: Retrieves a user by username.
** `onboardUser(String username, String password)`: Handles the logic for user onboarding.
** `assignVehicleToUser(String username, String vin, String brand, String country)`: Assigns a vehicle to a user.

=== UsermanagementApplicationTests

This class contains tests for the UsermanagementApplication.

* *Annotations*:
** `@SpringBootTest`: Provides a bridge between Spring Boot test features and JUnit.
** `@Test`: Denotes that a method is a test method.

== Runtime View Diagrams

=== Sequence Diagram for User Registration

[plantuml, user-registration-sequence, png]
----
@startuml
actor User
participant UserManagementController
participant UserManagementService
participant IdentityProviderClient
participant UserManagementRepository

User -> UserManagementController : onboardUser(username, password)
activate UserManagementController

UserManagementController -> UserManagementService : onboardUser(username, password)
activate UserManagementService

UserManagementService -> IdentityProviderClient : createIdentity(username, password)
activate IdentityProviderClient
IdentityProviderClient -> UserManagementService : identityCreated
deactivate IdentityProviderClient

UserManagementService -> UserManagementRepository : save(newUser)
activate UserManagementRepository
UserManagementRepository -> UserManagementService : userSaved
deactivate UserManagementRepository

UserManagementService -> UserManagementController : userOnboarded
deactivate UserManagementService

UserManagementController -> User : return userOnboarded
deactivate UserManagementController
@enduml
----

=== Sequence Diagram for Authentication/Login Flow

[plantuml, authentication-sequence, png]
----
@startuml
actor User
participant UserManagementController
participant UserManagementService
participant IdentityProviderClient

User -> UserManagementController : authenticate(username, password)
activate UserManagementController

UserManagementController -> UserManagementService : authenticateUser(username, password)
activate UserManagementService

UserManagementService -> IdentityProviderClient : validateCredentials(username, password)
activate IdentityProviderClient
IdentityProviderClient -> UserManagementService : credentialsValidated
deactivate IdentityProviderClient

UserManagementService -> UserManagementController : return authenticationResult
deactivate UserManagementService

UserManagementController -> User : return authenticationResult
deactivate UserManagementController
@enduml
----

=== Sequence Diagram for JWT Token Validation

[plantuml, jwt-validation-sequence, png]
----
@startuml
actor User
participant UserManagementController
participant UserManagementService
participant IdentityProviderClient

User -> UserManagementController : validateToken(jwtToken)
activate UserManagementController

UserManagementController -> UserManagementService : validateToken(jwtToken)
activate UserManagementService

UserManagementService -> IdentityProviderClient : checkTokenValidity(jwtToken)
activate IdentityProviderClient
IdentityProviderClient -> UserManagementService : tokenIsValid
deactivate IdentityProviderClient

UserManagementService -> UserManagementController : return validationOutcome
deactivate UserManagementService

UserManagementController -> User : return validationOutcome
deactivate UserManagementController
@enduml
----

=== Sequence Diagram for Exception Handling

[plantuml, exception-handling-sequence, png]
----
@startuml
actor User
participant UserManagementController
participant UserManagementService
participant IdentityProviderClient

User -> UserManagementController : performAction()
activate UserManagementController

UserManagementController -> UserManagementService : initiateAction()
activate UserManagementService

alt actionSuccessful
    UserManagementService -> UserManagementController : successResponse
    deactivate UserManagementService
    UserManagementController -> User : return successResponse
else actionFailed
    UserManagementService -> UserManagementController : throw new ActionException
    deactivate UserManagementService
    UserManagementController -> User : return errorResponse
end

deactivate UserManagementController
@enduml
----

== Entity Relationship Diagram

[plantuml, entity-relationship-diagram, png]
----
@startuml
entity "MobilityUser" {
    * id : Long
    * mobilityUserId : String
    * role : String
    * username : String
    * vin : String
}

note right of MobilityUser : MobilityUser stores information about users and their associated vehicles.
@enduml
----

=== Entity Description

* **MobilityUser**: Represents a user in the system. Each user has a unique ID (`id`), a mobility user ID (`mobilityUserId`), a role (`role`), a username (`username`), and a vehicle identification number (`vin`).

== Detailed Component Interactions

=== Controller-Service-Repository Interactions

* **UserManagementController**:
  - Receives HTTP requests from clients.
  - Calls appropriate methods in **UserManagementService**.
  - Returns responses based on the results from the service layer.

* **UserManagementService**:
  - Contains business logic.
  - Interacts with **IdentityProviderClient** and **VehicleManagementClient** for external communications.
  - Communicates with **UserManagementRepository** for data persistence.

* **UserManagementRepository**:
  - Interface to the database.
  - Used by the service layer to retrieve and store data related to users.

=== Data Flow Through Layers

1. **Controller** receives a request.
2. **Service** processes the request, possibly interacting with external systems.
3. **Repository** modifies or queries the database.
4. Data flows back through the layers to the user.

=== Exception Propagation

* Exceptions are typically thrown from the service layer.
* The controller layer catches these exceptions and translates them into appropriate HTTP responses.

=== Transaction Boundaries

* Defined at the service layer.
* Each public service method starts a new transaction, which is committed on success and rolled back on exception.

This detailed design document provides a comprehensive overview of the User Management System, suitable for developers involved in maintaining or extending the system.